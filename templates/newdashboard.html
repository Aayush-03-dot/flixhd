<!DOCTYPE html>
<html lang="en" x-data="adminDashboard()" class="dark" x-cloak>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlixHD - Admin Console</title>
    
    <!-- Fonts: Outfit for that modern App feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            bg: '#141414',       /* Main Background */
                            surface: '#1F1F1F',  /* Card Background */
                            red: '#e50914',      /* Netflix Red */
                            redDark: '#b20710',
                            gray: '#B3B3B3',     /* Muted Text */
                            dark: '#000000',
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }

        /* Custom Dark Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background-color: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #e50914; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #141414;
            color: #ffffff;
        }

        /* --- Glass Panel Design --- */
        .glass-panel {
            background: rgba(31, 31, 31, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        /* Hover effect for interactive cards */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.15); /* Red glow */
            border-color: rgba(229, 9, 20, 0.4);
        }

        /* Form Inputs */
        .custom-input {
            background-color: #262626;
            border: 1px solid #404040;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            width: 100%;
        }
        .custom-input:focus {
            outline: none;
            border-color: #e50914;
            box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2);
            background-color: #303030;
        }
        .custom-input::placeholder { color: #6b7280; }

        /* Custom Table Styles */
        .ott-table th { color: #9ca3af; font-weight: 500; font-size: 0.85rem; letter-spacing: 0.05em; text-transform: uppercase; padding: 1rem; }
        .ott-table td { padding: 1rem; border-bottom: 1px solid #262626; color: #e5e5e5; }
        .ott-table tr:hover td { background-color: rgba(255,255,255,0.03); }

        /* Animation Delay Helpers */
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
    </style>
</head>
<body class="antialiased overflow-hidden">
    
    <div class="flex h-screen w-full bg-brand-bg relative">
        
        <!-- Background Ambient Glow -->
        <div class="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-brand-red/10 to-transparent pointer-events-none z-0"></div>

        <!-- Sidebar -->
        <aside :class="isSidebarOpen ? 'translate-x-0' : '-translate-x-full'" 
               class="fixed lg:relative inset-y-0 left-0 z-50 w-72 flex flex-col bg-black/90 backdrop-blur-xl border-r border-white/10 transition-transform duration-300 ease-in-out">
            
            <!-- Logo Area -->
            <div class="flex flex-col justify-center h-24 px-8 border-b border-white/10 shrink-0">
                <h1 class="text-3xl font-extrabold tracking-tighter text-brand-red drop-shadow-lg">
                    Flix<span class="text-white">HD</span><span class="text-xs text-white/50 font-normal ml-2 tracking-normal">Admin</span>
                </h1>
                <div class="text-xs text-brand-gray mt-1 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    Online: {{session.user}}
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
                
                <a @click="currentTab = 'dashboard'; $event.preventDefault();" href="#" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all duration-200 group" 
                   :class="isActive('dashboard') ? 'bg-gradient-to-r from-brand-red to-brand-redDark text-white shadow-lg shadow-brand-red/20' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:scale-110 transition-transform"></i><span>Dashboard</span>
                </a>

                <div class="text-[11px] font-bold text-white/30 uppercase tracking-widest px-4 pt-6 pb-2">Content</div>
                
                <a @click="currentTab = 'add'; $event.preventDefault();" href="#" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all group" 
                   :class="isActive('add') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-brand-red group-hover:scale-110 transition-transform"></i><span>Add Movie/Series</span>
                </a>
                <a @click="currentTab = 'manage'; $event.preventDefault();" href="#" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all group" 
                   :class="isActive('manage') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                    <i data-lucide="film" class="w-5 h-5 text-purple-500 group-hover:scale-110 transition-transform"></i><span>Library</span>
                </a>
                <a @click="currentTab = 'requests'; $event.preventDefault();" href="#" 
                    class="flex items-center justify-between px-4 py-3 rounded-lg font-medium transition-all group" 
                    :class="isActive('requests') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                     <div class="flex items-center gap-3"><i data-lucide="mail-question" class="w-5 h-5 text-yellow-500"></i><span>Requests</span></div>
                     <template x-if="stats.pendingRequests > 0"><span class="px-2 py-0.5 text-[10px] font-bold text-black bg-yellow-500 rounded-full animate-pulse" x-text="stats.pendingRequests"></span></template>
                 </a>

                <div class="text-[11px] font-bold text-white/30 uppercase tracking-widest px-4 pt-6 pb-2">Users & Data</div>
                
                <a @click="currentTab = 'users'; $event.preventDefault();" href="#" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all group" 
                   :class="isActive('users') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                    <i data-lucide="users" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i><span>Users</span>
                </a>
                <a @click="currentTab = 'pending_users'; $event.preventDefault();" href="#" 
                    class="flex items-center justify-between px-4 py-3 rounded-lg font-medium transition-all group" 
                    :class="isActive('pending_users') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                     <div class="flex items-center gap-3"><i data-lucide="user-plus" class="w-5 h-5 text-green-500"></i><span>Approvals</span></div>
                     <template x-if="stats.pendingUsers > 0"><span class="px-2 py-0.5 text-[10px] font-bold text-black bg-green-500 rounded-full animate-pulse" x-text="stats.pendingUsers"></span></template>
                 </a>
                <a @click="currentTab = 'messages'; $event.preventDefault();" href="#" 
                    class="flex items-center justify-between px-4 py-3 rounded-lg font-medium transition-all group" 
                    :class="isActive('messages') ? 'bg-white/10 text-white border border-white/10' : 'text-brand-gray hover:bg-white/5 hover:text-white'">
                     <div class="flex items-center gap-3"><i data-lucide="message-square" class="w-5 h-5 text-pink-500"></i><span>Inbox</span></div>
                     <template x-if="stats.totalNewMessages > 0"><span class="px-2 py-0.5 text-[10px] font-bold text-black bg-pink-500 rounded-full animate-pulse" x-text="stats.totalNewMessages"></span></template>
                 </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-6 border-t border-white/10">
                <a href="{{ url_for('admin_logout') }}" class="flex items-center justify-center gap-2 w-full py-2.5 rounded-lg bg-white/5 hover:bg-brand-red hover:text-white text-brand-gray transition-all duration-300">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col relative z-10 overflow-hidden">
            
            <!-- Mobile Header -->
            <header class="flex lg:hidden items-center justify-between h-16 px-6 bg-black/80 backdrop-blur-md border-b border-white/10 z-40">
                <div class="text-xl font-bold text-white">FlixHD</div>
                <button type="button" @click="isSidebarOpen = !isSidebarOpen" class="p-2 text-white hover:bg-white/10 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </header>
            
            <!-- Backdrop for Mobile Sidebar -->
            <div x-show="isSidebarOpen" @click="isSidebarOpen = false" class="fixed inset-0 z-40 bg-black/80 lg:hidden backdrop-blur-sm" 
                 x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" 
                 x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>

            <!-- Content Scroll Area -->
            <main class="flex-1 p-6 lg:p-10 overflow-y-auto scroll-smooth">
                
                <!-- Title & Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 animate-fade-in-up">
                    <div>
                        <h2 class="text-3xl font-bold text-white capitalize" x-text="currentTab === 'dashboard' ? 'Overview' : currentTab.replace(/_/g, ' ')"></h2>
                        <p class="text-brand-gray text-sm mt-1">Manage your platform efficiently</p>
                    </div>
                    <!-- User Profile Dropdown could go here, simplified for now -->
                </div>

                <!-- 1. DASHBOARD TAB -->
                <div x-show="currentTab === 'dashboard'" class="space-y-8">
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Stat Card 1 -->
                        <div class="glass-panel p-6 hover-lift animate-fade-in-up delay-100 border-l-4 border-brand-red">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-brand-gray text-xs font-bold uppercase tracking-wider">Movies</p>
                                    <p class="text-4xl font-extrabold text-white mt-2" x-text="stats.totalMovies ?? 0"></p>
                                </div>
                                <div class="p-3 bg-brand-red/10 rounded-xl text-brand-red"><i data-lucide="film" class="w-6 h-6"></i></div>
                            </div>
                        </div>

                        <!-- Stat Card 2 -->
                        <div class="glass-panel p-6 hover-lift animate-fade-in-up delay-200 border-l-4 border-purple-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-brand-gray text-xs font-bold uppercase tracking-wider">TV Series</p>
                                    <p class="text-4xl font-extrabold text-white mt-2" x-text="stats.totalSeries ?? 0"></p>
                                </div>
                                <div class="p-3 bg-purple-500/10 rounded-xl text-purple-500"><i data-lucide="tv" class="w-6 h-6"></i></div>
                            </div>
                        </div>

                        <!-- Stat Card 3 -->
                        <div class="glass-panel p-6 hover-lift animate-fade-in-up delay-300 border-l-4 border-blue-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-brand-gray text-xs font-bold uppercase tracking-wider">Total Users</p>
                                    <p class="text-4xl font-extrabold text-white mt-2" x-text="stats.totalUsers ?? 0"></p>
                                </div>
                                <div class="p-3 bg-blue-500/10 rounded-xl text-blue-500"><i data-lucide="users" class="w-6 h-6"></i></div>
                            </div>
                        </div>

                        <!-- Stat Card 4 -->
                        <div class="glass-panel p-6 hover-lift animate-fade-in-up delay-300 border-l-4 border-yellow-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-brand-gray text-xs font-bold uppercase tracking-wider">Pending Req</p>
                                    <p class="text-4xl font-extrabold text-white mt-2" x-text="stats.pendingRequests ?? 0"></p>
                                </div>
                                <div class="p-3 bg-yellow-500/10 rounded-xl text-yellow-500"><i data-lucide="bell" class="w-6 h-6"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions / Recent Activity (Placeholder for visual completeness) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in-up delay-300">
                         <div class="glass-panel p-6">
                            <h3 class="text-lg font-bold text-white mb-4">Quick Shortcuts</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button @click="currentTab = 'add'" class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-brand-red hover:border-brand-red transition-all text-left group">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-brand-gray group-hover:text-white mb-2"></i>
                                    <span class="block text-sm font-semibold">Upload Content</span>
                                </button>
                                <button @click="currentTab = 'users'" class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-blue-600 hover:border-blue-600 transition-all text-left group">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-brand-gray group-hover:text-white mb-2"></i>
                                    <span class="block text-sm font-semibold">Manage Users</span>
                                </button>
                            </div>
                         </div>
                         <div class="glass-panel p-6 flex flex-col justify-center items-center text-center">
                            <div class="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center text-green-500 mb-3 animate-pulse">
                                <i data-lucide="activity" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white">System Status: Healthy</h3>
                            <p class="text-sm text-brand-gray">All services are running normally.</p>
                         </div>
                    </div>
                </div>

                <!-- 2. ADD CONTENT TAB -->
                <div x-show="currentTab === 'add'" class="animate-fade-in-up">
                    <form id="contentUploadForm" method="POST" action="{{ url_for('add_content') }}" enctype="multipart/form-data" @submit.prevent="handleFormSubmit($event)" class="glass-panel p-8">
                        {{ form.hidden_tag() }}
                        <!-- Hidden Inputs (State) -->
                        <input type="hidden" name="content_type" x-model="contentType">
                        <input type="hidden" id="tmdb_id_hidden" name="tmdb_id">
                        <input type="hidden" id="poster_url_hidden" name="poster_url">
                        <input type="hidden" id="backdrop_url_hidden" name="backdrop_url">
                        <input type="hidden" id="actors_json" name="actors_json">

                        <!-- Content Type Toggle -->
                        <div class="flex justify-center mb-8">
                            <div class="bg-black/50 p-1.5 rounded-full border border-white/10 inline-flex">
                                <button type="button" @click="contentType = 'movie'" 
                                    :class="contentType === 'movie' ? 'bg-brand-red text-white shadow-lg' : 'text-brand-gray hover:text-white'" 
                                    class="px-8 py-2.5 rounded-full font-semibold text-sm transition-all duration-300">Movie</button>
                                <button type="button" @click="contentType = 'series'" 
                                    :class="contentType === 'series' ? 'bg-brand-red text-white shadow-lg' : 'text-brand-gray hover:text-white'" 
                                    class="px-8 py-2.5 rounded-full font-semibold text-sm transition-all duration-300">TV Series</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- Left: Form Fields -->
                            <div class="lg:col-span-2 space-y-5">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Title</label>
                                        <input type="text" id="title" name="title" required class="custom-input" placeholder="e.g. Inception">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Release Date</label>
                                        <input type="date" id="release_date" name="release_date" class="custom-input [color-scheme:dark]">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Description</label>
                                    <textarea id="description" name="description" rows="4" class="custom-input" placeholder="Movie synopsis..."></textarea>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Genres</label>
                                        <input type="text" id="genres" name="genres" class="custom-input" placeholder="Action, Sci-Fi">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Director</label>
                                        <input type="text" id="director" name="director" class="custom-input" placeholder="Christopher Nolan">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-brand-gray uppercase mb-1">Cast</label>
                                    <input type="text" id="actors" name="actors" class="custom-input" placeholder="Leonardo DiCaprio, Ellen Page...">
                                </div>

                                <div x-show="contentType === 'movie'">
                                    <label class="block text-xs font-bold text-brand-red uppercase mb-1">Embed Code (iFrame/URL)</label>
                                    <textarea id="movie_embed_code" name="movie_embed_code" :required="contentType === 'movie'" rows="3" class="custom-input font-mono text-sm text-yellow-500 bg-black/40 border-yellow-500/30 focus:border-yellow-500" placeholder="<iframe...>"></textarea>
                                </div>

                                <div>
                                    <label for="download_url" class="block text-xs font-bold text-brand-gray uppercase mb-1">Download Link</label>
                                    <div class="relative">
                                        <i data-lucide="download-cloud" class="absolute left-3 top-3 w-5 h-5 text-gray-500"></i>
                                        <input type="url" id="download_url" name="download_url" class="custom-input pl-10" placeholder="https://drive.google.com/...">
                                    </div>
                                </div>
                            </div>

                            <!-- Right: TMDB Fetcher -->
                            <div class="lg:col-span-1 space-y-6">
                                <div class="bg-brand-surface border border-white/10 rounded-xl p-5 shadow-inner">
                                    <h3 class="text-white font-bold mb-4 flex items-center gap-2"><img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_2-d537fb228cf3ded904ef09b136fe3fec72548ebc1fea3fbbd1ad9e36364db38b.svg" class="w-8 h-8"> Auto-Fetch</h3>
                                    <div class="space-y-3">
                                        <input type="text" id="tmdb_search_title" placeholder="Search by Title..." class="custom-input">
                                        <input type="text" id="tmdb_movie_id" placeholder="Or TMDB ID..." class="custom-input">
                                        <button type="button" @click="fetchTmdbData($el)" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-blue-900/40">
                                            Search TMDB
                                        </button>
                                        <div id="tmdb_fetch_status" class="text-center text-xs h-4"></div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-brand-gray uppercase mb-2">Poster Image</label>
                                    <div class="relative w-full aspect-[2/3] bg-black/40 rounded-lg border border-white/10 overflow-hidden group cursor-pointer">
                                        <input type="file" id="thumbnail" name="thumbnail" @change="showPosterPreview" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer">
                                        <img id="fetched_poster_preview" src="" class="absolute inset-0 w-full h-full object-cover hidden z-10">
                                        <div class="absolute inset-0 flex flex-col items-center justify-center text-brand-gray group-hover:text-white transition-colors z-0">
                                            <i data-lucide="image-plus" class="w-10 h-10 mb-2"></i>
                                            <span class="text-xs">Click to Upload</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Series Episodes Section -->
                        <div x-show="contentType === 'series'" class="mt-8 pt-8 border-t border-white/10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-white">Episodes Manager</h3>
                                <button type="button" @click="addSeason" class="text-xs bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded border border-white/10 transition">
                                    + Add Season
                                </button>
                            </div>
                            <div class="space-y-4">
                                <template x-for="(season, seasonIndex) in seasons" :key="seasonIndex">
                                    <div class="bg-black/30 border border-white/10 rounded-xl p-4">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-bold text-brand-red" x-text="'Season ' + (seasonIndex + 1)"></h4>
                                            <button type="button" @click="removeSeason(seasonIndex)" class="text-brand-gray hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                        <div class="space-y-2 pl-2 border-l-2 border-white/10">
                                            <template x-for="(episode, episodeIndex) in season.episodes" :key="episodeIndex">
                                                <div class="grid grid-cols-12 gap-2 items-center">
                                                    <div class="col-span-1 text-center"><span class="text-xs text-brand-gray">Ep</span><input type="number" x-model.number="episode.number" class="custom-input text-center p-1 h-8"></div>
                                                    <div class="col-span-4"><input type="text" x-model="episode.title" placeholder="Title" class="custom-input p-1 h-8 text-sm"></div>
                                                    <div class="col-span-6"><input type="text" x-model="episode.embed_code" placeholder="Embed URL" class="custom-input p-1 h-8 text-sm font-mono text-yellow-500"></div>
                                                    <div class="col-span-1 text-right"><button type="button" @click="removeEpisode(seasonIndex, episodeIndex)" class="text-brand-gray hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                                                </div>
                                            </template>
                                            <button type="button" @click="addEpisode(seasonIndex)" class="mt-2 text-xs text-blue-400 hover:underline">+ Add Episode</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Progress Bar & Submit -->
                        <div id="uploadStatus" class="mt-6 hidden">
                            <div class="w-full bg-black/50 rounded-full h-2 border border-white/10 overflow-hidden">
                                <div id="progressBar" class="bg-brand-red h-full rounded-full transition-all duration-300 w-0 shadow-[0_0_10px_#e50914]"></div>
                            </div>
                            <p id="uploadPercent" class="text-center text-xs text-brand-gray mt-2 font-mono">Uploading 0%</p>
                        </div>

                        <div class="mt-8 flex justify-end">
                            <button type="submit" id="uploadBtn" class="bg-brand-red hover:bg-brand-redDark text-white font-bold py-3 px-10 rounded-full shadow-lg shadow-brand-red/40 transition-all transform hover:scale-105 active:scale-95">
                                Publish Content
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 3. MANAGE LIBRARY TAB -->
                <div x-show="currentTab === 'manage'" class="animate-fade-in-up">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                        <template x-for="item in managedContent" :key="item.id">
                            <div class="group relative aspect-[2/3] bg-black rounded-lg overflow-hidden border border-white/10 hover:border-brand-red transition-all duration-300 hover:shadow-2xl hover:shadow-brand-red/20 hover:scale-105">
                                <img :src="item.display_thumbnail" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                
                                <!-- Hover Overlay -->
                                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col justify-end p-4">
                                    <h3 class="text-white font-bold leading-tight line-clamp-2" x-text="item.title"></h3>
                                    <div class="flex gap-2 mt-3">
                                        <button @click="openEditModal(item)" class="flex-1 bg-white text-black py-1.5 rounded font-bold text-xs hover:bg-gray-200">Edit</button>
                                        <button @click="confirmDelete(item, 'content')" class="bg-red-600/20 text-red-500 border border-red-600/50 p-1.5 rounded hover:bg-red-600 hover:text-white transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="contentLoading" class="text-center py-12"><div class="inline-block w-8 h-8 border-4 border-brand-red border-t-transparent rounded-full animate-spin"></div></div>
                    
                    <div x-show="hasNextPage && !contentLoading" class="flex justify-center mt-10">
                        <button @click="loadMoreContent()" class="px-6 py-2 rounded-full border border-white/20 hover:bg-white/10 text-white transition">Load More</button>
                    </div>

                    <div x-show="!contentLoading && managedContent.length === 0" class="text-center py-20 text-brand-gray">
                        <i data-lucide="film" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                        <p>No content found in the library.</p>
                    </div>
                </div>

                <!-- 4. USERS / REQUESTS / MESSAGES (Generalized Table View) -->
                <div x-show="['users', 'requests', 'messages', 'pending_users'].includes(currentTab)" class="animate-fade-in-up">
                    
                    <!-- Search Bar for Users -->
                    <div x-show="currentTab === 'users'" class="mb-6">
                        <div class="relative max-w-md">
                            <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500"></i>
                            <input type="text" x-model.debounce.500ms="userSearchQuery" @input="performUserSearch()" placeholder="Search users..." class="custom-input pl-12 rounded-full">
                        </div>
                    </div>

                    <div class="glass-panel overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full ott-table text-left border-collapse">
                                <thead>
                                    <!-- Dynamic Headers based on Tab -->
                                    <tr class="bg-white/5 border-b border-white/10">
                                        <template x-if="currentTab === 'users' || currentTab === 'pending_users'">
                                            <th class="w-1/4">User</th>
                                        </template>
                                        <template x-if="currentTab === 'users' || currentTab === 'pending_users'">
                                            <th class="w-1/4">Email</th>
                                        </template>
                                        <template x-if="currentTab === 'users'">
                                            <th>Status</th>
                                        </template>
                                        <template x-if="currentTab === 'requests'">
                                            <th>Movie Title</th>
                                        </template>
                                        <template x-if="currentTab === 'requests'">
                                            <th>Status</th>
                                        </template>
                                        <template x-if="currentTab === 'messages'">
                                            <th>From</th>
                                        </template>
                                        <template x-if="currentTab === 'messages'">
                                            <th>Subject</th>
                                        </template>
                                        <th class="text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Users Row -->
                                    <template x-for="user in (currentTab === 'users' ? users : (currentTab === 'pending_users' ? pendingUsers : []))" :key="user.id">
                                        <tr class="transition-colors hover:bg-white/5">
                                            <td class="font-medium text-white" x-text="user.username"></td>
                                            <td class="text-brand-gray" x-text="user.email"></td>
                                            <template x-if="currentTab === 'users'">
                                                <td>
                                                    <span class="px-2 py-1 rounded text-xs font-bold" 
                                                        :class="user.is_active ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'"
                                                        x-text="user.is_active ? 'Active' : 'Banned'"></span>
                                                </td>
                                            </template>
                                            <td class="text-right space-x-2">
                                                <template x-if="currentTab === 'pending_users'">
                                                    <button @click="approvePendingUser(user.id)" class="text-green-400 hover:text-green-300 p-1"><i data-lucide="check-circle" class="w-5 h-5"></i></button>
                                                </template>
                                                <template x-if="currentTab === 'users'">
                                                    <button @click="openUserEditModal(user)" class="text-blue-400 hover:text-blue-300 p-1"><i data-lucide="edit" class="w-5 h-5"></i></button>
                                                </template>
                                                <button @click="confirmDelete(user, currentTab === 'users' ? 'user' : 'pending_user')" class="text-red-500 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- Requests Row -->
                                    <template x-for="req in movieRequests" :key="req.id">
                                        <tr x-show="currentTab === 'requests'" class="transition-colors hover:bg-white/5">
                                            <td class="font-medium text-white" x-text="req.title"></td>
                                            <td>
                                                <span class="px-2 py-1 rounded text-xs font-bold" 
                                                    :class="req.status == 'Pending' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'"
                                                    x-text="req.status"></span>
                                            </td>
                                            <td class="text-right space-x-2">
                                                <button x-show="req.status == 'Pending'" @click="completeRequest(req.id)" class="text-green-400 hover:text-green-300 text-xs font-bold border border-green-500/50 px-2 py-1 rounded">Mark Done</button>
                                                <button @click="confirmDelete(req, 'request')" class="text-red-500 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- Messages Row -->
                                    <template x-for="msg in contactMessages" :key="msg.id">
                                        <tr x-show="currentTab === 'messages'" class="transition-colors hover:bg-white/5" :class="{'bg-brand-red/5': msg.status === 'New'}">
                                            <td>
                                                <div class="font-bold text-white" x-text="msg.name"></div>
                                                <div class="text-xs text-brand-gray" x-text="msg.date"></div>
                                            </td>
                                            <td class="text-brand-gray truncate max-w-[200px]" x-text="msg.subject"></td>
                                            <td class="text-right space-x-2">
                                                <button @click="openMessageDetailsModal(msg)" class="text-blue-400 hover:text-blue-300 p-1"><i data-lucide="eye" class="w-5 h-5"></i></button>
                                                <button @click="confirmDelete(msg, 'message')" class="text-red-500 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty States -->
                        <div x-show="(currentTab === 'users' && users.length === 0) || (currentTab === 'requests' && movieRequests.length === 0) || (currentTab === 'messages' && contactMessages.length === 0)" class="p-8 text-center text-brand-gray">
                            Nothing to see here yet.
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- === MODALS (Global, Glassmorphic) === -->
    
    <!-- 1. Edit Content Modal -->
    <div x-show="isEditModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" 
         x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
        <div @click.away="closeEditModal()" class="glass-panel w-full max-w-2xl bg-[#141414] border-gray-700 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-brand-red"></div>
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Edit Content</h3>
                <button @click="closeEditModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form @submit.prevent="handleEditSubmit($el)" class="p-6 overflow-y-auto max-h-[70vh] space-y-4">
                {{ form.hidden_tag() }}
                <input type="hidden" name="movieId" x-model="editMovieData.id">
                <input type="hidden" id="actors_json_edit" name="actors_json"> 
                
                <div><label class="text-xs font-bold text-brand-gray uppercase">Title</label><input type="text" name="title" x-model="editMovieData.title" class="custom-input mt-1"></div>
                <div><label class="text-xs font-bold text-brand-gray uppercase">Description</label><textarea name="description" x-model="editMovieData.description" rows="3" class="custom-input mt-1"></textarea></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-brand-gray uppercase">Genres</label><input type="text" name="genres" x-model="editMovieData.genre" class="custom-input mt-1"></div>
                    <div><label class="text-xs font-bold text-brand-gray uppercase">Date</label><input type="date" name="release_date" x-model="editMovieData.release_date" class="custom-input mt-1 [color-scheme:dark]"></div>
                </div>

                <div><label class="text-xs font-bold text-brand-gray uppercase">Embed Code</label><textarea name="embed_code" x-model="editMovieData.embed_code" rows="3" class="custom-input mt-1 font-mono text-yellow-500"></textarea></div>
                <div><label class="text-xs font-bold text-brand-gray uppercase">Download Link</label><input type="url" name="download_url" x-model="editMovieData.download_url" class="custom-input mt-1"></div>

                <div class="flex justify-end gap-3 pt-4 border-t border-white/10">
                    <button type="button" @click="closeEditModal()" class="px-4 py-2 rounded-lg border border-white/20 text-white hover:bg-white/10">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-brand-red text-white font-bold hover:bg-red-700 shadow-lg shadow-red-900/50">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Confirmation Modal (Warning Style) -->
    <div x-show="isCustomConfirmModalOpen" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/90 backdrop-blur-md p-4" x-transition>
        <div class="glass-panel w-full max-w-sm text-center p-8 border border-red-500/30 shadow-[0_0_50px_rgba(229,9,20,0.2)]">
            <div class="mx-auto w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center text-brand-red mb-4 animate-pulse">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2" x-text="customConfirmTitle">Confirm</h3>
            <p class="text-brand-gray text-sm mb-8" x-text="customConfirmBody"></p>
            <div class="flex gap-4">
                <button @click="closeCustomConfirmModal()" class="flex-1 py-3 rounded-lg border border-white/20 text-white hover:bg-white/10 font-medium">Cancel</button>
                <button @click="confirmCustomAction()" class="flex-1 py-3 rounded-lg bg-brand-red text-white font-bold hover:bg-red-700 shadow-lg shadow-red-600/20">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 3. Message/User Edit Modals (Reusing Glass Panel style implicitly via code logic below, but structure provided in original code remains mapped) -->
    <!-- (I will include the User Edit Modal structure here updated visually) -->
    <div x-show="isUserEditModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-transition>
        <div @click.away="closeUserEditModal()" class="glass-panel w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-white mb-4">Manage User</h3>
            <form @submit.prevent="handleUserEditSubmit()" class="space-y-4">
                {{ form.hidden_tag() }}
                <input type="hidden" name="user_id" :value="editUserData.id">
                <div><label class="text-xs font-bold text-brand-gray uppercase">Username</label><input type="text" name="username" x-model="editUserData.username" class="custom-input mt-1"></div>
                <div><label class="text-xs font-bold text-brand-gray uppercase">Email</label><input type="email" name="email" x-model="editUserData.email" class="custom-input mt-1"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-brand-gray uppercase">Role</label>
                        <select name="role" x-model="editUserData.role" class="custom-input mt-1 bg-[#262626]">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-brand-gray uppercase">Status</label>
                        <select name="is_active" x-model="editUserData.is_active" class="custom-input mt-1 bg-[#262626]">
                            <option :value="true">Active</option>
                            <option :value="false">Suspended</option>
                        </select>
                    </div>
                </div>
                <div><label class="text-xs font-bold text-brand-gray uppercase">New Password</label><input type="password" name="password" x-model="editUserData.new_password" class="custom-input mt-1" placeholder="Leave blank to keep"></div>
                
                <!-- Security Question & Answer -->
                <div><label class="text-xs font-bold text-brand-gray uppercase">Security Question</label><input type="text" name="security_question" x-model="editUserData.security_question" class="custom-input mt-1"></div>
                <div><label class="text-xs font-bold text-brand-gray uppercase">Security Answer</label><input type="text" name="security_answer" x-model="editUserData.security_answer" class="custom-input mt-1"></div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" @click="closeUserEditModal()" class="px-4 py-2 text-sm text-brand-gray hover:text-white">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded bg-white text-black font-bold hover:bg-gray-200">Update User</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Message Details Modal -->
    <div x-show="isMessageDetailsModalOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-transition>
        <div @click.away="closeMessageDetailsModal()" class="glass-panel w-full max-w-lg p-6 relative">
            <button @click="closeMessageDetailsModal()" class="absolute top-4 right-4 text-brand-gray hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-lg font-bold text-white mb-1">Message Details</h3>
            <p class="text-sm text-brand-gray mb-6" x-text="selectedMessage.date"></p>
            
            <div class="space-y-4">
                <div class="bg-white/5 p-3 rounded border border-white/10">
                    <p class="text-xs text-brand-gray uppercase">From</p>
                    <p class="text-white" x-text="selectedMessage.name + ' <' + selectedMessage.email + '>'"></p>
                </div>
                <div>
                    <p class="text-xs text-brand-gray uppercase mb-1">Subject</p>
                    <p class="text-white font-medium text-lg" x-text="selectedMessage.subject || 'No Subject'"></p>
                </div>
                <div class="bg-black/40 p-4 rounded-lg border border-white/5 min-h-[100px]">
                    <p class="text-brand-gray text-sm whitespace-pre-wrap" x-text="selectedMessage.message"></p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                 <template x-if="selectedMessage.status === 'New'">
                    <button @click="markMessageRead(selectedMessage.id); closeMessageDetailsModal();" class="px-6 py-2 rounded bg-brand-red text-white font-bold hover:bg-red-700">Mark as Read</button>
                </template>
                <button @click="closeMessageDetailsModal()" class="ml-2 px-4 py-2 rounded border border-white/20 text-white hover:bg-white/10">Close</button>
            </div>
        </div>
    </div>

    <!-- TOASTS (Notification Popups) -->
    <div class="fixed top-6 right-6 z-[120] flex flex-col gap-3 w-full max-w-xs pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" @click="removeToast(toast.id)"
                 class="pointer-events-auto transform transition-all duration-300 glass-panel p-4 flex items-center gap-3 border-l-4 cursor-pointer shadow-2xl bg-[#141414]"
                 :class="{ 'border-green-500': toast.type === 'success', 'border-red-500': toast.type === 'error', 'border-blue-500': toast.type === 'info' }"
                 x-transition:enter="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="translate-x-full opacity-0">
                
                <div class="shrink-0">
                    <template x-if="toast.type === 'success'"><i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i></template>
                    <template x-if="toast.type === 'error'"><i data-lucide="alert-octagon" class="w-6 h-6 text-red-500"></i></template>
                    <template x-if="toast.type === 'info'"><i data-lucide="info" class="w-6 h-6 text-blue-500"></i></template>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-white" x-text="toast.message"></p>
                </div>
            </div>
        </template>
    </div>

    <!-- MAIN LOGIC (UNCHANGED) -->
    <script>
    function adminDashboard() {
        return {
            // --- Alpine.js State Management ---
            isSidebarOpen: window.innerWidth >= 1024,
            currentTab: 'dashboard',
            contentType: 'movie',
            seasons: [],

            isEditModalOpen: false,
            editMovieData: {},
            isUserEditModalOpen: false,
            editUserData: {},
            isMessageDetailsModalOpen: false,
            selectedMessage: {},

            // Custom Confirmation Modal state
            isCustomConfirmModalOpen: false,
            customConfirmTitle: '',
            customConfirmBody: '',
            customConfirmCallback: null,

            toasts: [],
            uploadXhr: null,

            // Stats from backend - will now be used directly
            stats: {
                totalMovies: null, totalSeries: null, pendingRequests: null,
                totalUsers: null, pendingUsers: null, totalNewMessages: null
            },

            managedContent: [],
            contentPage: 1, hasNextPage: false, contentLoading: false,
            movieRequests: [],
            users: [],
            userPage: 1, hasMoreUsers: false, usersLoading: false,
            userSearchQuery: '',
            contactMessages: [],
            messagesLoading: false,
            pendingUsers: [],
            pendingUsersLoading: false,
            requestsLoading: false,

            // State to hold TMDB data for series before submission
            tmdbFetchedSeriesData: {
                tmdb_id: null,
                poster_url: null,
                backdrop_url: null,
                genres: [],
                actors: [],
                director: null,
                release_date: null,
                overview: null,
                title: null
            },

            // --- Initialization Logic ---
            init() {
                // Watch for changes in the currentTab to load data or close sidebar
                this.$watch('currentTab', (tab) => {
                    if(window.innerWidth < 1024) this.isSidebarOpen = false;

                    if(tab === 'manage' && this.managedContent.length === 0) this.loadMoreContent();
                    if(tab === 'requests' && this.movieRequests.length === 0) this.loadRequests();
                    if(tab === 'users') {
                        if (this.users.length === 0 || this.userSearchQuery !== '') {
                            this.performUserSearch();
                        }
                    }
                    if(tab === 'messages') {
                        if (this.contactMessages.length === 0) {
                            this.loadContactMessages();
                        }
                    }
                    if(tab === 'pending_users') {
                        if (this.pendingUsers.length === 0) {
                            this.loadPendingUsers();
                        }
                    }
                });

                this.addSeason(); // Initializes one season/episode for the add content form

                // Initial data load when the dashboard page loads
                this.$nextTick(() => {
                    this.loadStats(); // Call loadStats to fetch actual data
                    lucide.createIcons(); // Ensures icons are rendered
                });
            },

            // --- General UI Helpers ---
            isActive(tab) {
                return this.currentTab === tab;
            },

            // --- Dashboard Stats Logic ---
            async loadStats() {
                try {
                    const response = await fetch("{{ url_for('get_stats') }}");
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Network response was not ok');
                    }
                    this.stats = await response.json(); 
                    this.$nextTick(() => lucide.createIcons());
                } catch (error) {
                    this.addToast(`Failed to load stats: ${error.message}`, 'error');
                    console.error("Error loading stats:", error);
                }
            },

            // --- Content Management Logic ---
            async loadMoreContent() {
                if (this.contentLoading) return;
                this.contentLoading = true;
                try {
                    const response = await fetch(`{{ url_for('get_content') }}?page=${this.contentPage}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error loading content.');
                    }
                    const data = await response.json();
                    this.managedContent.push(...data.items);
                    this.hasNextPage = data.has_next;
                    if(data.has_next) this.contentPage = data.next_page_number;
                } catch (error) {
                    this.addToast(`Error loading content: ${error.message}`, 'error');
                    console.error("Error loading content:", error);
                } finally {
                    this.contentLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            handleFormSubmit(event) {
                const form = event.target;
                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.disabled = true;
                document.getElementById('uploadStatus').style.display = 'block';

                const csrfToken = document.querySelector('[name="csrf_token"]').value;

                if (this.contentType === 'series') {
                    const seriesData = {
                        title: document.getElementById('title').value,
                        description: document.getElementById('description').value,
                        genres: document.getElementById('genres').value,
                        release_date: document.getElementById('release_date').value,
                        director: document.getElementById('director').value,
                        tmdb_id: this.tmdbFetchedSeriesData.tmdb_id,
                        poster_url: this.tmdbFetchedSeriesData.poster_url,
                        backdrop_url: this.tmdbFetchedSeriesData.backdrop_url,
                        content_type: 'series',
                        seasons: this.seasons.map((season, index) => ({ title: `Season ${index + 1}`, episodes: season.episodes })),
                        actors: this.tmdbFetchedSeriesData.actors, // Correctly pass structured actors
                        download_url: document.getElementById('download_url').value
                    };
                    document.getElementById('progressBar').style.width = '50%';
                    document.getElementById('uploadPercent').textContent = `Processing...`;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(seriesData)
                    })
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok) throw new Error(data.message || 'Server error');
                        document.getElementById('progressBar').style.width = '100%';
                        this.addToast(data.message || 'Series added successfully!', 'success');
                        this.managedContent.unshift(data.item);
                        form.reset();
                        this.seasons = [];
                        this.addSeason();
                        
                        this.tmdbFetchedSeriesData = {
                            tmdb_id: null, poster_url: null, backdrop_url: null,
                            genres: [], actors: [], director: null, release_date: null, overview: null, title: null
                        };
                        document.getElementById('fetched_poster_preview').src = '#';
                        document.getElementById('fetched_poster_preview').style.display = 'none';
                        document.getElementById('tmdb_search_title').value = '';
                        document.getElementById('tmdb_movie_id').value = '';
                        document.getElementById('tmdb_fetch_status').innerHTML = '';


                        this.currentTab = 'manage';
                        this.loadStats();
                    })
                    .catch(error => {
                        this.addToast(`Error adding series: ${error.message}`, 'error');
                        console.error("Error adding series:", error);
                    })
                    .finally(() => {
                        uploadBtn.disabled = false;
                        document.getElementById('uploadStatus').style.display = 'none';
                    });
                } else { // Movie content type
                    const movieEmbedCodeInput = document.getElementById('movie_embed_code');
                    if (!movieEmbedCodeInput || !movieEmbedCodeInput.value.trim()) {
                        this.addToast('Movie Embed Code / URL is required!', 'error');
                        uploadBtn.disabled = false;
                        document.getElementById('uploadStatus').style.display = 'none';
                        return;
                    }

                    const formData = new FormData(form);
                    formData.set('tmdb_id', document.getElementById('tmdb_id_hidden') ? document.getElementById('tmdb_id_hidden').value : '');
                    formData.set('poster_url', document.getElementById('poster_url_hidden') ? document.getElementById('poster_url_hidden').value : '');
                    formData.set('backdrop_url', document.getElementById('backdrop_url_hidden') ? document.getElementById('backdrop_url_hidden').value : '');
                    formData.set('actors_json', document.getElementById('actors_json') ? document.getElementById('actors_json').value : '[]'); // Ensures full JSON is sent

                    this.uploadXhr = new XMLHttpRequest();
                    this.uploadXhr.open('POST', form.action, true);
                    this.uploadXhr.setRequestHeader('X-CSRFToken', csrfToken);

                    this.uploadXhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            document.getElementById('progressBar').style.width = percent + '%';
                            document.getElementById('uploadPercent').textContent = `Uploading ${percent}%`;
                        }
                    };

                    this.uploadXhr.onload = () => {
                        if (this.uploadXhr.status >= 200 && this.uploadXhr.status < 300) {
                            const result = JSON.parse(this.uploadXhr.responseText);
                            this.addToast(result.message || 'Movie added successfully!', 'success');
                            this.managedContent.unshift(result.item);
                            form.reset();
                            if (document.getElementById('tmdb_id_hidden')) document.getElementById('tmdb_id_hidden').value = '';
                            if (document.getElementById('poster_url_hidden')) document.getElementById('poster_url_hidden').value = '';
                            if (document.getElementById('backdrop_url_hidden')) document.getElementById('backdrop_url_hidden').value = '';
                            if (document.getElementById('actors_json')) document.getElementById('actors_json').value = '[]'; // Reset actors_json
                            document.getElementById('fetched_poster_preview').src = '#';
                            document.getElementById('fetched_poster_preview').style.display = 'none';
                            document.getElementById('tmdb_search_title').value = '';
                            document.getElementById('tmdb_movie_id').value = '';
                            document.getElementById('tmdb_fetch_status').innerHTML = '';

                            this.currentTab = 'manage';
                            this.loadStats();
                        } else {
                            const errorResult = JSON.parse(this.uploadXhr.responseText);
                            this.addToast(errorResult.message || 'Upload failed. Please try again.', 'error');
                            console.error("Upload error:", errorResult);
                        }
                        uploadBtn.disabled = false;
                        document.getElementById('uploadStatus').style.display = 'none';
                    };

                    this.uploadXhr.onerror = () => {
                        this.addToast('A network error occurred during upload.', 'error');
                        console.error("Network error during upload.");
                        uploadBtn.disabled = false;
                        document.getElementById('uploadStatus').style.display = 'none';
                    };
                    this.uploadXhr.send(formData);
                }
            },

            async handleEditSubmit(form) {
                const formData = new FormData(form);
                const movieId = formData.get('movieId');
                const actionUrl = `{{ url_for('api_edit_movie', movie_id=0) }}`.replace('0', movieId);

                // Ensure actors_json_edit value is correctly picked up by FormData
                // FormData automatically picks up inputs with 'name' attribute.
                // If 'actors_json_edit' has name="actors_json", it should be fine.
                // You might want to explicitly set it here to be absolutely sure:
                formData.set('actors_json', document.getElementById('actors_json_edit').value);


                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': '{{ form.csrf_token._value() }}' }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update content.');
                    }
                    const result = await response.json();

                    const index = this.managedContent.findIndex(m => m.id == movieId);
                    if (index !== -1) {
                        this.managedContent[index] = { ...this.managedContent[index], ...result.item };
                    }

                    this.closeEditModal();
                    this.addToast(result.message || 'Content updated!', 'success');
                    this.loadStats();
                } catch (error) {
                    this.addToast(`Error updating content: ${error.message}`, 'error');
                    console.error("Error updating content:", error);
                }
            },

            // --- Custom Confirmation Modal Methods ---
            openCustomConfirm(title, callback, body = '') {
                this.customConfirmTitle = title;
                this.customConfirmBody = body;
                this.customConfirmCallback = callback;
                this.isCustomConfirmModalOpen = true;
            },

            confirmCustomAction() {
                if (typeof this.customConfirmCallback === 'function') {
                    this.customConfirmCallback();
                } else {
                    this.addToast('Error: Confirmation action not set correctly. Please check console.', 'error');
                }
                this.closeCustomConfirmModal();
            },

            closeCustomConfirmModal() {
                this.isCustomConfirmModalOpen = false;
                this.customConfirmCallback = null;
                this.customConfirmTitle = '';
                this.customConfirmBody = '';
            },

            confirmDelete(item, type) {
                const itemTitle = item.username || item.title || item.subject || item.name || 'this item';
                const callback = () => {
                    this.executeDelete(item.id, type, item.content_type);
                };
                let bodyText = `You are about to permanently delete ${itemTitle}. This action cannot be undone.`;
                if (type === 'user' && item.role === 'admin') {
                    bodyText = `WARNING: You are about to delete an ADMIN user: ${itemTitle}. Proceed with caution! This action cannot be undone!`;
                }
                this.openCustomConfirm('Confirm Deletion', callback, bodyText);
            },

            async executeDelete(id, type, contentType) {
                let url;
                if (type === 'content') {
                    url = contentType === 'movie'
                        ? `{{ url_for('delete_movie', movie_id=0) }}`.replace('0', id)
                        : `{{ url_for('delete_series', series_id=0) }}`.replace('0', id);
                } else if (type === 'user') {
                    url = `{{ url_for('admin_manage_user', user_id=0) }}`.replace('0', id);
                } else if (type === 'request') {
                    url = `{{ url_for('delete_request', request_id=0) }}`.replace('0', id);
                } else if (type === 'message') {
                    url = `{{ url_for('admin_delete_message', message_id=0) }}`.replace('0', id);
                } else if (type === 'pending_user') {
                    url = `{{ url_for('admin_delete_pending_user', pending_user_id=0) }}`.replace('0', id);
                } else {
                    this.addToast('Invalid deletion type.', 'error');
                    return;
                }

                try {
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': '{{ form.csrf_token._value() }}' }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Deletion failed.');
                    }
                    const result = await response.json();

                    if (type === 'content') {
                        this.managedContent = this.managedContent.filter(item => item.id !== id);
                        this.addToast(result.message || 'Content deleted.', 'success');
                    } else if (type === 'user') {
                        this.users = this.users.filter(user => user.id !== id);
                        this.addToast(result.message || 'User deleted.', 'success');
                        this.loadStats();
                    } else if (type === 'request') {
                        this.movieRequests = this.movieRequests.filter(req => req.id !== id);
                        this.addToast(result.message || 'Request deleted.', 'success');
                        this.loadStats();
                    } else if (type === 'message') {
                        this.contactMessages = this.contactMessages.filter(msg => msg.id !== id);
                        this.addToast(result.message || 'Message deleted.', 'success');
                        this.loadStats();
                    } else if (type === 'pending_user') {
                        this.pendingUsers = this.pendingUsers.filter(user => user.id !== id);
                        this.addToast(result.message || 'Pending user deleted.', 'success');
                        this.loadStats();
                    }
                } catch (error) {
                    this.addToast(`Error deleting: ${error.message}`, 'error');
                }
            },

            // --- Movie Request Management Logic ---
            async loadRequests() {
                if (this.requestsLoading) return;
                this.requestsLoading = true;
                try {
                    const response = await fetch("{{ url_for('get_requests') }}");
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Could not fetch requests.');
                    }
                    this.movieRequests = await response.json();
                } catch (error) {
                    this.addToast(`Error loading requests: ${error.message}`, 'error');
                } finally {
                    this.requestsLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async completeRequest(requestId) {
                const requestItem = this.movieRequests.find(r => r.id === requestId);
                const callback = () => {
                    this._completeRequestAction(requestId);
                };
                this.openCustomConfirm(`Confirm Completion`, callback, `Mark request for "${requestItem.title}" as completed?`);
            },
            async _completeRequestAction(requestId) {
                try {
                    this.closeCustomConfirmModal();
                    const response = await fetch(`{{ url_for('complete_request', request_id=0) }}`.replace('0', requestId), {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ form.csrf_token._value() }}' }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Action failed.');
                    }
                    const result = await response.json();

                    const index = this.movieRequests.findIndex(r => r.id === requestId);
                    if (index !== -1) this.movieRequests[index] = result.updated_request;

                    this.addToast(result.message || 'Request marked as complete.', 'success');
                    this.loadStats();
                } catch (error) {
                    this.addToast(`Error completing request: ${error.message}`, 'error');
                }
            },

            // --- TMDB Integration Logic ---
            async fetchTmdbData(btn) {
                const statusDiv = document.getElementById('tmdb_fetch_status');
                statusDiv.innerHTML = `<span class="text-white animate-pulse">Searching the database...</span>`;
                btn.disabled = true;
                try {
                    const response = await fetch(`{{ url_for('fetch_tmdb_data_route') }}?type=${this.contentType}&title=${encodeURIComponent(document.getElementById('tmdb_search_title').value)}&tmdb_id=${encodeURIComponent(document.getElementById('tmdb_movie_id').value)}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || errorData.message || 'TMDB fetch failed.');
                    }
                    const data = await response.json();
                    if (data.not_found) throw new Error(data.message || 'Content not found.');

                    document.getElementById('title').value = data.title || '';
                    document.getElementById('description').value = data.overview || '';
                    document.getElementById('genres').value = data.genres ? data.genres.join(', ') : '';
                    document.getElementById('release_date').value = data.release_date || '';
                    // Populate the visible input for names
                    document.getElementById('actors').value = (data.actors || []).map(a => a.name).join(', ');
                    document.getElementById('director').value = data.director || '';

                    if (this.contentType === 'series') {
                        this.tmdbFetchedSeriesData.tmdb_id = data.tmdb_id || null;
                        this.tmdbFetchedSeriesData.poster_url = data.poster_url || null;
                        this.tmdbFetchedSeriesData.backdrop_url = data.backdrop_url || null;
                        this.tmdbFetchedSeriesData.genres = data.genres || [];
                        this.tmdbFetchedSeriesData.actors = data.actors || []; // Store full actor objects
                        this.tmdbFetchedSeriesData.director = data.director || null;
                        this.tmdbFetchedSeriesData.release_date = data.release_date || null;
                        this.tmdbFetchedSeriesData.overview = data.overview || null;
                        this.tmdbFetchedSeriesData.title = data.title || null;
                    } else {
                        if (document.getElementById('tmdb_id_hidden')) {
                            document.getElementById('tmdb_id_hidden').value = data.tmdb_id || '';
                        }
                        if (document.getElementById('poster_url_hidden')) {
                            document.getElementById('poster_url_hidden').value = data.poster_url || '';
                        }
                        if (document.getElementById('backdrop_url_hidden')) {
                            document.getElementById('backdrop_url_hidden').value = data.backdrop_url || '';
                        }
                        if (document.getElementById('actors_json')) {
                            // Store the full JSON string of actor objects including profile_path
                            document.getElementById('actors_json').value = JSON.stringify(data.actors || []);
                        }
                    }

                    const preview = document.getElementById('fetched_poster_preview');
                    if (data.poster_url) { preview.src = data.poster_url; preview.style.display = 'block'; }
                    else { preview.style.display = 'none'; }

                    statusDiv.innerHTML = `<span class="text-green-500 font-bold">Data imported successfully!</span>`;
                } catch (error) {
                    statusDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                } finally {
                    btn.disabled = false;
                }
            },
            showPosterPreview(event) {
                const reader = new FileReader();
                if (event.target.files[0]) {
                    reader.onload = (e) => {
                        const p = document.getElementById('fetched_poster_preview');
                        p.src = e.target.result;
                        p.style.display = 'block';
                    };
                    reader.readAsDataURL(event.target.files[0]);
                }
            },
            openEditModal(item) {
                if (item.content_type === 'series') {
                    // Redirect to the dedicated edit_series page
                    window.location.href = `{{ url_for('edit_series', series_id=0) }}`.replace('0', item.id);
                    return;
                }
                this.editMovieData = { ...item };
                
                // CRUCIAL FOR BUG 1 FIX: Populate the hidden actors_json_edit field
                if (item.cast) {
                    // Assuming item.cast is already the parsed JSON array of objects from backend's to_dict()
                    document.getElementById('actors_json_edit').value = JSON.stringify(item.cast);
                } else {
                    document.getElementById('actors_json_edit').value = '[]';
                }

                // Also populate hidden TMDB fields for the modal's use, if any.
                // (Though for movie edits, these values might not be directly used from the form unless re-fetched)
                // They are more relevant for the Add Content form, but good to have consistency.
                document.getElementById('tmdb_id_hidden').value = item.tmdb_id || ''; // Re-using this ID from add form, okay for now.
                document.getElementById('poster_url_hidden').value = item.poster_url || '';
                document.getElementById('backdrop_url_hidden').value = item.backdrop_url || '';

                this.isEditModalOpen = true;
                this.$nextTick(() => {
                    lucide.createIcons(); // Re-render icons if any in the modal
                });
            },
            closeEditModal() {
                this.isEditModalOpen = false;
                // Optionally clear editMovieData after closing if you wish
                this.editMovieData = {};
            },

            // --- Series Seasons/Episodes Management (Add Content Form) ---
            addSeason() { this.seasons.push({ episodes: [{ number: 1, title: '', embed_code: '' }] }); this.$nextTick(() => { lucide.createIcons(); }); },
            addEpisode(seasonIndex) { this.seasons[seasonIndex].episodes.push({ number: this.seasons[seasonIndex].episodes.length + 1, title: '', embed_code: '' }); this.$nextTick(() => { lucide.createIcons(); }); },
            removeSeason(seasonIndex) { this.seasons.splice(seasonIndex, 1); },
            removeEpisode(seasonIndex, episodeIndex) { this.seasons[seasonIndex].episodes.splice(episodeIndex, 1); },

            // --- Toast Notification System ---
            addToast(msg, type = 'success', duration = 5000) {
                const id = Date.now();
                const toast = {
                    id, message: msg, type, visible: true, duration, percent: 100,
                    timeoutId: null,
                    intervalId: null
                };
                this.toasts.push(toast);
                this.$nextTick(() => { lucide.createIcons(); });

                toast.intervalId = setInterval(() => {
                    const t = this.toasts.find(t => t.id === id);
                    if (t) {
                        t.percent -= (100 / (duration / 100));
                        if (t.percent < 0) t.percent = 0;
                    }
                }, 100);

                toast.timeoutId = setTimeout(() => {
                    this.removeToast(id);
                }, duration);
            },
            removeToast(id) {
                const toastIndex = this.toasts.findIndex(t => t.id === id);
                if (toastIndex > -1) {
                    const toastToRemove = this.toasts[toastIndex];

                    if (toastToRemove.timeoutId) {
                        clearTimeout(toastToRemove.timeoutId);
                    }
                    if (toastToRemove.intervalId) {
                        clearInterval(toastToRemove.intervalId);
                    }

                    toastToRemove.visible = false;

                    setTimeout(() => {
                        this.toasts.splice(toastIndex, 1);
                    }, 300);
                }
            },

            // --- User Management Methods ---
            async loadUsers(resetPage = false) {
                if (this.usersLoading) return;
                this.usersLoading = true;

                if (resetPage) {
                    this.users = [];
                    this.userPage = 1;
                }

                try {
                    const response = await fetch(`{{ url_for('admin_get_users') }}?page=${this.userPage}${this.userSearchQuery ? `&search=${encodeURIComponent(this.userSearchQuery)}` : ''}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error loading users.');
                    }
                    const data = await response.json();
                    this.users.push(...data.users);
                    this.hasMoreUsers = data.has_next;
                    if(data.has_next) this.userPage = data.next_num;
                } catch (error) {
                    this.addToast(`Error loading users: ${error.message}`, 'error');
                    console.error("Error loading users:", error);
                } finally {
                    this.usersLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            performUserSearch() {
                this.loadUsers(true);
            },

            openUserEditModal(user) {
                this.editUserData = { ...user, new_password: '' };
                this.editUserData.is_active = String(user.is_active);
                this.isUserEditModalOpen = true;
            },

            closeUserEditModal() {
                this.isUserEditModalOpen = false;
                this.editUserData = {};
            },

            async handleUserEditSubmit() {
                const userId = this.editUserData.id;
                const url = `{{ url_for('admin_manage_user', user_id=0) }}`.replace('0', userId);

                const dataToSend = {
                    username: this.editUserData.username,
                    email: this.editUserData.email,
                    role: this.editUserData.role,
                    is_active: this.editUserData.is_active === 'true',
                    security_question: this.editUserData.security_question,
                    security_answer: this.editUserData.security_answer,
                };

                if (this.editUserData.new_password) {
                    dataToSend.password = this.editUserData.new_password;
                }

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ form.csrf_token._value() }}'
                        },
                        body: JSON.stringify(dataToSend)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update user.');
                    }
                    const result = await response.json();

                    const index = this.users.findIndex(u => u.id === userId);
                    if (index !== -1) {
                        this.users[index] = { ...this.users[index], ...result.user };
                        this.users[index].is_active = String(result.user.is_active);
                    }
                    this.addToast(result.message || 'User updated successfully!', 'success');
                    this.closeUserEditModal();
                    this.loadStats();
                } catch (error) {
                    this.addToast(`Error updating user: ${error.message}`, 'error');
                }
            },

            async toggleUserActiveStatus(user) {
                const actionVerb = user.is_active ? 'suspend' : 'activate';
                const callback = () => {
                    this._toggleUserActiveStatusAction(user);
                };
                this.openCustomConfirm(`Confirm ${actionVerb} User`, callback, `Are you sure you want to ${actionVerb} user ${user.username}?`);
            },
            async _toggleUserActiveStatusAction(user) {
                try {
                    this.closeCustomConfirmModal();
                    const url = `{{ url_for('admin_manage_user', user_id=0) }}`.replace('0', user.id);
                    const newStatus = !user.is_active;

                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ form.csrf_token._value() }}'
                        },
                        body: JSON.stringify({ is_active: newStatus })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to change user status.');
                    }
                    const result = await response.json();

                    user.is_active = newStatus;
                    const userIndex = this.users.findIndex(u => u.id === user.id);
                    if (userIndex !== -1) {
                        this.users[userIndex].is_active = newStatus;
                    }

                    this.addToast(result.message || `User ${user.username} has been ${newStatus ? 'activated' : 'suspended'}.`, 'success');
                    this.loadStats();
                } catch (error) {
                    this.addToast(`Error changing user status: ${error.message}`, 'error');
                }
            },

            // --- Contact Message Management Methods ---
            async loadContactMessages() {
                if (this.messagesLoading) return;
                this.messagesLoading = true;
                try {
                    const response = await fetch("{{ url_for('admin_get_messages') }}");
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Could not fetch messages.');
                    }
                    this.contactMessages = await response.json();
                } catch (error) {
                    this.addToast(`Error loading messages: ${error.message}`, 'error');
                } finally {
                    this.messagesLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            openMessageDetailsModal(msg) {
                this.selectedMessage = { ...msg };
                this.isMessageDetailsModalOpen = true;
                if (msg.status === 'New') {
                    this._markMessageReadAction(msg.id, false);
                }
            },

            closeMessageDetailsModal() {
                this.isMessageDetailsModalOpen = false;
                this.selectedMessage = {};
            },

            async markMessageRead(messageId) {
                const messageItem = this.contactMessages.find(m => m.id === messageId);
                if (messageItem.status === 'Read') {
                    this.addToast('Message is already marked as read.', 'info');
                    return;
                }
                const callback = () => {
                    this._markMessageReadAction(messageId, true);
                };
                this.openCustomConfirm(`Confirm Mark as Read`, callback, `Mark message from "${messageItem.name}" as read?`);
            },
            async _markMessageReadAction(messageId, closeConfirmModal = true) {
                try {
                    if (closeConfirmModal) this.closeCustomConfirmModal();

                    const response = await fetch(`{{ url_for('admin_mark_message_read', message_id=0) }}`.replace('0', messageId), {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ form.csrf_token._value() }}' }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to mark message as read.');
                    }
                    const result = await response.json();

                    const index = this.contactMessages.findIndex(m => m.id === messageId);
                    if (index !== -1) {
                        this.contactMessages[index] = result.updated_message;
                    }
                    this.addToast(result.message || 'Message marked as read.', 'success');
                    this.loadStats();
                } catch (error) {
                    this.addToast(`Error marking message as read: ${error.message}`, 'error');
                }
            },

            // --- Pending User Management Methods ---
            async loadPendingUsers() {
                if (this.pendingUsersLoading) return;
                this.pendingUsersLoading = true;
                try {
                    const response = await fetch("{{ url_for('admin_get_pending_users') }}");
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Could not fetch pending users.');
                    }
                    this.pendingUsers = await response.json();
                } catch (error) {
                    this.addToast(`Error loading pending users: ${error.message}`, 'error');
                } finally {
                    this.pendingUsersLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async approvePendingUser(userId) {
                const userItem = this.pendingUsers.find(u => u.id === userId);
                const callback = () => {
                    this._approvePendingUserAction(userId);
                };
                this.openCustomConfirm(`Confirm Approval`, callback, `Are you sure you want to approve user "${userItem.username}"? This will create an active account.`);
            },
            async _approvePendingUserAction(userId) {
                try {
                    this.closeCustomConfirmModal();
                    const url = `{{ url_for('admin_approve_pending_user', pending_user_id=0) }}`.replace('0', userId);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ form.csrf_token._value() }}' }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to approve user.');
                    }
                    const result = await response.json();

                    this.pendingUsers = this.pendingUsers.filter(user => user.id !== userId);
                    this.addToast(result.message || 'User approved successfully!', 'success');
                    this.loadStats();
                    this.loadUsers(true);
                } catch (error) {
                    this.addToast(`Error approving user: ${error.message}`, 'error');
                }
            },
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered! Scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }
    </script>
</body>
</html>