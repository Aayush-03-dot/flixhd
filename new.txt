<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Visionary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon/favicon-movie1.png') }}">
    <style>
        :root {
            --primary-bg: #0f0f1a;
            --secondary-bg-rgb: 22, 22, 38;
            --glass-opacity: 0.65;
            --glass-blur: 8px;
            --card-border-color: rgba(112, 82, 240, 0.3);
            --accent-color: #7e57c2;
            --accent-hover-color: #673ab7;
            --text-color: #e8eaf6;
            --muted-text-color: #bdc1c6;
            --heading-color: #ffffff;
            --input-bg: rgba(40, 40, 60, 0.7);
            --input-focus-border: var(--accent-color);
            --success-color: #4caf50;
            --danger-color: #f44336;
            --danger-hover-color: #d32f2f;
            --warning-color: #ff9800;
            --warning-hover-color: #f57c00;
            --white-text: #ffffff;
            --font-family: 'Poppins', sans-serif;
        }
        body { background: var(--primary-bg) url('https://www.transparenttextures.com/patterns/stardust.png'); color: var(--text-color); font-family: var(--font-family); line-height: 1.7; padding-top: 20px; }
        .dashboard-container { margin-top: 20px; margin-bottom: 40px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .dashboard-header h2 { color: var(--heading-color); font-weight: 600; font-size: 2rem; }
        .dashboard-header h2 i { margin-right: 12px; color: var(--accent-color); filter: drop-shadow(0 0 5px var(--accent-color)); }
        .card { background-color: rgba(var(--secondary-bg-rgb), var(--glass-opacity)); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--card-border-color); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); color: var(--text-color); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(var(--accent-color), 0.2); }
        .card-header-custom { background-color: rgba(var(--secondary-bg-rgb), 0.3); border-bottom: 1px solid var(--card-border-color); font-size: 1.3rem; font-weight: 500; padding: 1.25rem 1.75rem; color: var(--accent-color); }
        .card-header-custom i { margin-right: 10px; }
        .card-body-custom { padding: 1.75rem; }
        .form-label { color: var(--muted-text-color); font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--card-border-color); border-radius: 10px; padding: 0.85rem 1.1rem; transition: all 0.2s ease; font-size: 0.95rem; }
        .form-control:focus, .form-select:focus { background-color: rgba(40, 40, 60, 0.9); color: var(--white-text); border-color: var(--input-focus-border); box-shadow: 0 0 0 0.2rem rgba(var(--accent-color), 0.25); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e8eaf6' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); }
        .form-control::placeholder { color: var(--muted-text-color); opacity: 0.8; }
        .form-control[type="file"]::-webkit-file-upload-button { background-color: var(--accent-color); color: var(--white-text); border: none; padding: 0.75rem 1.1rem; border-radius: 8px; margin-right: 12px; cursor: pointer; transition: background-color 0.2s ease; font-weight: 500; }
        .form-control[type="file"]::-webkit-file-upload-button:hover { background-color: var(--accent-hover-color); }
        .btn-custom { border: none; padding: 0.85rem 1.75rem; font-weight: 500; border-radius: 10px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9rem; }
        .btn-custom:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 15px rgba(var(--accent-color), 0.2); }
        .btn-custom:active { transform: translateY(-1px) scale(0.98); }
        .btn-custom-upload { background: linear-gradient(45deg, var(--accent-color), var(--accent-hover-color)); color: var(--white-text); box-shadow: 0 4px 15px rgba(var(--accent-color), 0.3); }
        .btn-custom-logout { background: linear-gradient(45deg, var(--warning-color), var(--warning-hover-color)); color: var(--primary-bg); }
        .btn-custom-delete, .btn-custom-edit { padding: 0.5rem 1rem; font-size: 0.8rem; text-transform: none; letter-spacing: normal; }
        .btn-custom-delete { background-color: var(--danger-color); color: var(--white-text); }
        .btn-custom-delete:hover { background-color: var(--danger-hover-color); box-shadow: 0 5px 10px rgba(var(--danger-color),0.25); }
        .btn-custom-edit { background-color: var(--accent-color); color: var(--white-text); }
        .btn-custom-edit:hover { background-color: var(--accent-hover-color); box-shadow: 0 5px 10px rgba(var(--accent-color),0.2); }
        .btn-custom-cancel { background-color: #6c757d; color: var(--white-text); }
        .btn-custom-cancel:hover { background-color: #5a6268; }
        .upload-box { background: var(--input-bg); padding: 25px; border-radius: 10px; color: var(--text-color); box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-width: 100%; margin-top: 20px; border: 1px solid var(--card-border-color); }
        .upload-header { font-size: 1.25rem; font-weight: 500; padding: 10px 0; background-color: transparent; border-radius: 0; margin-bottom: 15px; color: var(--accent-color); text-align: center; }
        .progress-circle { width: 100px; height: 100px; position: relative; }
        .progress-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-circle .circle-bg { fill: none; stroke: var(--card-border-color); stroke-width: 4.2; }
        .progress-circle .circle { fill: none; stroke: var(--accent-color); stroke-width: 4.2; stroke-linecap: round; transition: stroke-dasharray 0.3s ease; }
        .progress-circle .percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 600; font-size: 1.1rem; color: var(--white-text); }
        .no-movies-message { color: var(--muted-text-color); text-align: center; padding: 2rem; font-size: 1.1rem;}
        .no-movies-message i { font-size: 1.5rem; margin-bottom: 0.5rem; display: block;}
        .modal-content { background-color: rgba(var(--secondary-bg-rgb), 0.85); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--card-border-color); border-radius: 16px; color: var(--text-color); }
        .modal-header { border-bottom: 1px solid var(--card-border-color); color: var(--accent-color); }
        .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .modal-title { font-weight: 500; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { border-top: 1px solid var(--card-border-color); }
        .nav-tabs { border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; }
        .nav-tabs .nav-link { color: var(--muted-text-color); border: none; border-bottom: 3px solid transparent; padding: 1rem 1.5rem; font-weight: 500; transition: color 0.3s ease, border-color 0.3s ease; background-color: transparent; }
        .nav-tabs .nav-link:hover { color: var(--accent-color); border-color: rgba(var(--accent-color), 0.5); }
        .nav-tabs .nav-link.active { color: var(--white-text); background-color: transparent; border-color: var(--accent-color); font-weight: 600; }
        .nav-tabs .nav-link.active:focus { border-color: var(--accent-color); text-decoration: none; }
        .movie-grid-card { position: relative; background-color: rgba(var(--secondary-bg-rgb), var(--glass-opacity)); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--card-border-color); border-radius: 16px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); color: var(--text-color); overflow: hidden; height: 100%; display: flex; flex-direction: column; }
        .movie-grid-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(var(--accent-color), 0.25); }
        .movie-thumbnail-container { width: 100%; padding-bottom: 150%; position: relative; overflow: hidden; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .movie-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .movie-grid-card:hover .movie-thumbnail { transform: scale(1.05); }
        .movie-card-body { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; }
        .movie-card-title { color: var(--white-text); font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem; line-height: 1.3; }
        .movie-card-text { font-size: 0.85rem; color: var(--muted-text-color); margin-bottom: 0.25rem; line-height: 1.4; }
        .movie-card-text.description { font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 0.75rem; min-height: 2.4em; }
        .movie-card-actions { margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: flex-end; gap: 0.75rem; }
        .requests-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .request-card { background-color: rgba(var(--secondary-bg-rgb), var(--glass-opacity)); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--card-border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .request-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(var(--accent-color), 0.2); }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .request-card-title { font-size: 1.2rem; font-weight: 600; color: var(--heading-color); word-break: break-word; }
        .request-status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 500; flex-shrink: 0; }
        .request-status-badge.pending { background-color: rgba(255, 152, 0, 0.2); color: var(--warning-color); }
        .request-status-badge.completed { background-color: rgba(76, 175, 80, 0.2); color: var(--success-color); }
        .request-card-body { font-size: 0.9rem; color: var(--muted-text-color); flex-grow: 1; display: flex; flex-direction: column; gap: 0.75rem; }
        .request-detail-item { display: flex; align-items: flex-start; gap: 0.75rem; }
        .request-detail-item i { color: var(--accent-color); margin-top: 3px; }
        .request-detail-item a { color: var(--accent-color); text-decoration: none; font-weight: 500; word-break: break-all; }
        .request-detail-item a:hover { text-decoration: underline; }
        .request-card-footer { padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 0.75rem; }
        .season-card { background-color: rgba(var(--secondary-bg-rgb), 0.4); border: 1px solid var(--card-border-color); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.25rem; }
        .season-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .season-title { color: var(--accent-color); font-weight: 600; font-size: 1.1rem; }
        .episode-item { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 1rem; }
        .episode-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .episode-inputs { display: contents; }
    </style>
</head>
<body>

    <div class="container dashboard-container">
        <div class="dashboard-header">
            <h2><i class="bi bi-stars"></i>Admin Dashboard</h2>
            <a href="{{ url_for('logout') }}" class="btn btn-custom btn-custom-logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab" aria-controls="upload-pane" aria-selected="true">
                    <i class="bi bi-cloud-arrow-up-fill"></i> Add Content
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab" aria-controls="manage-pane" aria-selected="false">
                    <i class="bi bi-film"></i> Manage Content
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests-pane" type="button" role="tab" aria-controls="requests-pane" aria-selected="false">
                    <i class="bi bi-envelope-paper-heart-fill"></i> Movie Requests
                    {% if requests and requests|selectattr('status', 'equalto', 'Pending')|list|length > 0 %}
                        <span class="badge bg-danger ms-2">{{ requests|selectattr('status', 'equalto', 'Pending')|list|length }}</span>
                    {% endif %}
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <div class="tab-pane fade show active" id="upload-pane" role="tabpanel" aria-labelledby="upload-tab">
                <div class="card mb-5">
                    <div class="card-header-custom">
                        <i class="bi bi-cloud-arrow-up-fill"></i> Add New Content to Site
                    </div>
                    <div class="card-body card-body-custom" >
                        
                        <form method="POST" enctype="multipart/form-data" id="contentUploadForm" action="{{ url_for('admin_dashboard') }}">
                            {{ form.hidden_tag() }}
                            
                            <div class="mb-4">
                                <label for="contentTypeSelect" class="form-label">Content Type</label>
                                <select class="form-select" id="contentTypeSelect" name="content_type">
                                    <option value="movie" selected>Movie</option>
                                    <option value="series">Web Series / Anime</option>
                                </select>
                            </div>

                            <div class="card p-3 mb-4" style="background-color: rgba(var(--secondary-bg-rgb), 0.3); border: 1px solid var(--card-border-color);">
                                <h6 class="mb-3 text-light"><i class="bi bi-search-heart"></i> Fetch Details from TMDB</h6>
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-5">
                                        <label for="tmdb_search_title" class="form-label visually-hidden">TMDB Title</label>
                                        <input type="text" class="form-control form-control-sm" id="tmdb_search_title" placeholder="Enter Movie Title to search TMDB...">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="tmdb_movie_id" class="form-label visually-hidden">TMDB ID (Optional)</label>
                                        <input type="text" class="form-control form-control-sm" id="tmdb_movie_id" placeholder="Or TMDB ID (more accurate)">
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" id="fetchTmdbDataBtn" class="btn btn-sm btn-custom" style="background-color: var(--accent-color); color: var(--white-text); width: 100%;">
                                            <i class="bi bi-download"></i> Fetch Data
                                        </button>
                                    </div>
                                </div>
                                <div id="tmdb_fetch_status" class="mt-2" style="font-size: 0.85rem;"></div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="title" name="title" placeholder="Enter title (or fetched from TMDB)" required>
                                </div>
                                <div class="col-md-12">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" placeholder="Enter description (or fetched from TMDB)" rows="3"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="genres" class="form-label">Genres (Comma-separated)</label>
                                    <input type="text" class="form-control" id="genres" name="genres" placeholder="e.g., Action, Comedy, Drama (from TMDB)">
                                </div>
                                <div class="col-md-6">
                                    <label for="release_date" class="form-label">Release Date</label>
                                    <input type="date" class="form-control" id="release_date" name="release_date">
                                </div>
                                <div class="col-md-6">
                                    <label for="actors" class="form-label">Cast (Comma-separated)</label>
                                    <input type="text" class="form-control" id="actors" name="actors" placeholder="e.g., Actor One, Actor Two (from TMDB)">
                                    <input type="hidden" id="actors_json" name="actors_json">
                                </div>
                                <div class="col-md-6">
                                    <label for="director" class="form-label">Director / Creator</label>
                                    <input type="text" class="form-control" id="director" name="director" placeholder="Director or Creator Name (from TMDB)">
                                </div>
                                <input type="hidden" id="tmdb_id_hidden" name="tmdb_id">
                                <input type="hidden" id="poster_url_hidden" name="poster_url">
                                
                                <div id="movie_embed_container" class="col-md-12 mt-3">
                                    <label for="movie_embed_code" class="form-label">Movie Embed Code / URL (from 3rd Party)</label>
                                    <textarea class="form-control" id="movie_embed_code" name="movie_embed_code" placeholder="Paste <iframe> embed code or direct video URL here" rows="3"></textarea>
                                    <small class="form-text" style="color: var(--muted-text-color);">This will be used to play the movie on your site.</small>
                                </div>

                                <div id="series_content_container" class="col-md-12 mt-3" style="display: none;">
                                    <h5 style="color: var(--heading-color); border-bottom: 1px solid var(--card-border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">Seasons & Episodes</h5>
                                    <div id="seasons_container">
                                    </div>
                                    <button type="button" id="addSeasonBtn" class="btn btn-custom mt-2" style="background-color: rgba(var(--accent-color), 0.8); color: var(--white-text);">
                                        <i class="bi bi-plus-circle-fill"></i> Add New Season
                                    </button>
                                </div>

                                <div class="col-md-12 mt-3">
                                    <label for="thumbnail" class="form-label">
                                        Local Thumbnail Image (Optional - Overrides TMDB poster)
                                    </label>
                                    <input type="file" class="form-control" id="thumbnail" name="thumbnail" accept="image/*">
                                    <img id="fetched_poster_preview" src="#" alt="TMDB Poster Preview" class="mt-2" style="max-height: 150px; display: none; border-radius: 8px; border: 1px solid var(--card-border-color);"/>
                                </div>
                            </div>
                            <div id="uploadStatus" class="upload-box mt-4" style="display: none;">
                                <div class="upload-header">Uploading...</div>
                                <div class="d-flex justify-content-center align-items: center my-3">
                                    <div class="progress-circle mx-auto">
                                        <svg viewBox="0 0 36 36">
                                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                            <path class="circle" id="progressCircle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                        </svg>
                                        <div class="percentage" id="uploadPercent">0%</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button type="button" id="cancelUpload" class="btn btn-custom btn-custom-cancel"><i class="bi bi-x-circle"></i> Cancel</button>
                                </div>
                            </div>
                            <div class="mt-4 pt-2 text-end"> 
                                <button type="submit" class="btn btn-custom btn-custom-upload" id="uploadBtn"><i class="bi bi-rocket-launch-fill"></i> Add Content to Site</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="manage-pane" role="tabpanel" aria-labelledby="manage-tab">
                <div class="card">
                    <div class="card-header-custom">
                        <i class="bi bi-film"></i> Manage Content
                    </div>
                    <div class="card-body card-body-custom">
                        {% if movies %}
                            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4"> 
                                {% for item in movies %}
                                    <div class="col"> 
                                        <div class="movie-grid-card"> 
                                            <div class="movie-thumbnail-container">
                                                <img src="{{ item.display_thumbnail }}" alt="{{ item.title }} Thumbnail" class="movie-thumbnail">
                                            </div>
                                            <div class="movie-card-body">
                                                <h5 class="movie-card-title">{{ item.title }} <span class="badge rounded-pill text-bg-secondary fw-normal">{{ item.content_type }}</span></h5>
                                                {% if item.description %}
                                                    <p class="movie-card-text description">{{ item.description | truncate(70, True) }}</p>
                                                {% endif %}
                                                {% if item.genre %} <p class="movie-card-text"><strong>Genre:</strong> {{ item.genre | truncate(40, True) }}</p>{% endif %}
                                                
                                                <div class="movie-card-actions">
                                                    {% if item.content_type == 'movie' %}
                                                        <button type="button" class="btn btn-sm btn-custom btn-custom-edit" 
                                                                data-bs-toggle="modal" data-bs-target="#editMovieModal"
                                                                data-movie-id="{{ item.id }}"
                                                                data-movie-title="{{ item.title | default('', true) }}"
                                                                data-movie-description="{{ item.description | default('', true) }}"
                                                                data-movie-genres="{{ item.genre | default('', true) }}" data-movie-release-date="{{ item.release_date | default('', true) }}"
                                                                data-movie-actors="{{ item.cast | default('', true) }}" data-movie-director="{{ item.director | default('', true) }}"
                                                                data-movie-embed-code="{{ item.embed_code | default('', true) }}"
                                                                data-movie-poster-url="{{ item.poster_url | default('', true) }}"
                                                                data-movie-thumbnail="{{ item.thumbnail | default('', true) }}"
                                                                data-movie-tmdb-id="{{ item.tmdb_id | default('', true) }}">
                                                            <i class="bi bi-pencil-square"></i> Edit
                                                        </button>
                                                    {% else %}
                                                        <a href="{{ url_for('edit_series', series_id=item.id) }}" class="btn btn-sm btn-custom btn-custom-edit">
                                                            <i class="bi bi-pencil-square"></i> Edit
                                                        </a>
                                                    {% endif %}

                                                    <form method="POST" action="{{ url_for('delete_series', series_id=item.id) if item.content_type == 'series' else url_for('delete_movie', movie_id=item.id) }}" class="d-inline">
                                                        {{ form.hidden_tag() }}
                                                        <button type="submit" class="btn btn-sm btn-custom btn-custom-delete" onclick="return confirm('Are you sure you want to delete \'{{ item.title }}\'? This action cannot be undone.');">
                                                            <i class="bi bi-trash3-fill"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="no-movies-message"><i class="bi bi-camera-reels"></i><br>No content uploaded yet. Start by adding some!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="requests-pane" role="tabpanel" aria-labelledby="requests-tab">
                <div class="card">
                    <div class="card-header-custom">
                        <i class="bi bi-envelope-paper-heart-fill"></i> Manage Movie Requests
                    </div>
                    <div class="card-body card-body-custom">
                        {% if requests %}
                            <div class="requests-grid">
                                {% for req in requests %}
                                <div class="request-card">
                                    <div class="request-card-header">
                                        <h4 class="request-card-title">{{ req.title }}</h4>
                                        <span class="request-status-badge {{ req.status|lower }}">{{ req.status }}</span>
                                    </div>
                                    <div class="request-card-body">
                                        {% if req.link %}
                                        <div class="request-detail-item">
                                            <i class="bi bi-link-45deg"></i>
                                            <a href="{{ req.link }}" target="_blank" rel="noopener noreferrer">Reference Link</a>
                                        </div>
                                        {% endif %}
                                        {% if req.notes %}
                                        <div class="request-detail-item">
                                            <i class="bi bi-chat-left-text-fill"></i>
                                            <span>{{ req.notes }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="request-detail-item">
                                            <i class="bi bi-clock-fill"></i>
                                            <span>Requested on: {{ req.date }}</span>
                                        </div>
                                    </div>
                                    <div class="request-card-footer">
                                        {% if req.status == 'Pending' %}
                                        <form method="POST" action="{{ url_for('complete_request', request_id=req.id) }}" class="d-inline">
                                            {{ form.hidden_tag() }}
                                            <button type="submit" class="btn btn-sm btn-custom" style="background-color: var(--success-color); color: white;">
                                                <i class="bi bi-check-circle-fill"></i> Mark as Completed
                                            </button>
                                        </form>
                                        {% endif %}
                                        <form method="POST" action="{{ url_for('delete_request', request_id=req.id) }}" class="d-inline">
                                            {{ form.hidden_tag() }}
                                            <button type="submit" class="btn btn-sm btn-custom btn-custom-delete" onclick="return confirm('Are you sure you want to delete this request?');">
                                                <i class="bi bi-trash3-fill"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="no-movies-message"><i class="bi bi-mailbox2"></i><br>There are currently no movie requests.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editMovieModal" tabindex="-1" aria-labelledby="editMovieModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMovieModalLabel"><i class="bi bi-pencil-fill"></i> Edit Movie Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editMovieForm">
                    {{ form.hidden_tag() }}
                    <div class="modal-body">
                        <input type="hidden" id="editMovieId" name="movieId">
                        <div class="mb-3">
                            <label for="editMovieTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="editMovieTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMovieDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editMovieDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editMovieGenres" class="form-label">Genres (Comma-separated)</label>
                                <input type="text" class="form-control" id="editMovieGenres" name="genres">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editMovieReleaseDate" class="form-label">Release Date</label>
                                <input type="date" class="form-control" id="editMovieReleaseDate" name="release_date">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editMovieActors" class="form-label">Cast (Comma-separated)</label>
                                <input type="text" class="form-control" id="editMovieActors" name="actors">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editMovieDirector" class="form-label">Director</label>
                                <input type="text" class="form-control" id="editMovieDirector" name="director">
                            </div>
                        </div>
                        <input type="hidden" id="editTmdbId" name="tmdb_id">
                        <div class="mb-3">
                            <label for="editPosterUrl" class="form-label">TMDB Poster URL (auto-filled if available)</label>
                            <input type="url" class="form-control" id="editPosterUrl" name="poster_url" placeholder="https://image.tmdb.org/t/p/w500/...">
                            <img id="edit_poster_preview" src="#" alt="Poster Preview" class="mt-2" style="max-height: 100px; display: none; border-radius: 4px; border: 1px solid var(--card-border-color);"/>
                        </div>
                        <div class="mb-3">
                            <label for="editMovieEmbedCode" class="form-label">Movie Embed Code / URL</label>
                            <textarea class="form-control" id="editMovieEmbedCode" name="embed_code" rows="3"></textarea>
                            <small class="d-block mt-1" style="color: var(--muted-text-color);">Current Embed: <span id="currentMovieEmbedCode" style="word-break: break-all;">-</span></small>
                        </div>
                        <div class="mb-3">
                            <label for="editMovieThumbnail" class="form-label">New Local Thumbnail (Optional - Overrides TMDB Poster)</label>
                            <input type="file" class="form-control" id="editMovieThumbnail" name="thumbnail" accept="image/*">
                            <small class="d-block mt-1" style="color: var(--muted-text-color);">Current Local Thumbnail: <span id="currentLocalThumbnailName">-</span></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-custom btn-custom-cancel" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cancel</button>
                        <button type="submit" class="btn btn-custom btn-custom-upload"><i class="bi bi-save-fill"></i> Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let uploadXhr;
        let seriesAbortController;

        const contentTypeSelect = document.getElementById('contentTypeSelect');
        const movieEmbedContainer = document.getElementById('movie_embed_container');
        const seriesContentContainer = document.getElementById('series_content_container');
        const movieEmbedCodeInput = document.getElementById('movie_embed_code');
        const fetchTmdbDataBtn = document.getElementById('fetchTmdbDataBtn');
        const tmdbSearchTitleInput = document.getElementById('tmdb_search_title');
        const contentUploadForm = document.getElementById('contentUploadForm');
        const uploadStatusDiv = document.getElementById('uploadStatus');
        const progressCircle = document.querySelector('.progress-circle');
        const progressCirclePath = document.getElementById('progressCircle');
        const uploadPercentText = document.getElementById('uploadPercent');
        const cancelUploadBtn = document.getElementById('cancelUpload');
        const uploadBtn = document.getElementById('uploadBtn');

        contentTypeSelect.addEventListener('change', function() {
            if (this.value === 'movie') {
                movieEmbedContainer.style.display = 'block';
                seriesContentContainer.style.display = 'none';
                movieEmbedCodeInput.required = true;
                tmdbSearchTitleInput.placeholder = 'Enter Movie Title...';
            } else {
                movieEmbedContainer.style.display = 'none';
                seriesContentContainer.style.display = 'block';
                movieEmbedCodeInput.required = false;
                tmdbSearchTitleInput.placeholder = 'Enter Series Title...';
            }
        });

        const addSeasonBtn = document.getElementById('addSeasonBtn');
        const seasonsContainer = document.getElementById('seasons_container');
        let seasonCounter = 0;
        addSeasonBtn.addEventListener('click', function() {
            seasonCounter++;
            const seasonCard = document.createElement('div');
            seasonCard.className = 'card season-card';
            seasonCard.innerHTML = `
                <div class="season-header">
                    <span class="season-title">Season ${seasonCounter}</span>
                    <button type="button" class="btn btn-sm btn-custom-delete remove-season-btn"><i class="bi bi-trash3-fill"></i></button>
                </div>
                <div class="episodes-container"></div>
                <button type="button" class="btn btn-sm btn-custom add-episode-btn mt-3" style="background-color: rgba(var(--accent-color), 0.6); color: var(--white-text); max-width: 200px;"><i class="bi bi-plus-square-dotted"></i> Add Episode</button>
            `;
            seasonsContainer.appendChild(seasonCard);
        });
        seasonsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-episode-btn')) {
                const episodesContainer = e.target.previousElementSibling;
                const episodeCount = episodesContainer.children.length + 1;
                const episodeItem = document.createElement('div');
                episodeItem.className = 'episode-item';
                episodeItem.innerHTML = `
                    <div class="flex-grow-1"><label class="form-label small">Ep ${episodeCount}</label><input type="number" class="form-control form-control-sm episode-number" value="${episodeCount}" style="max-width: 80px;"></div>
                    <div class="flex-grow-1"><label class="form-label small">Title</label><input type="text" class="form-control form-control-sm episode-title" placeholder="Episode Title"></div>
                    <div class="flex-grow-1"><label class="form-label small">Embed Code</label><input type="text" class="form-control form-control-sm episode-embed" placeholder="<iframe> or URL" required></div>
                    <button type="button" class="btn btn-sm btn-custom-delete remove-episode-btn mb-0"><i class="bi bi-x"></i></button>
                `;
                episodesContainer.appendChild(episodeItem);
            }
            if (e.target.closest('.remove-episode-btn')) { e.target.closest('.episode-item').remove(); }
            if (e.target.classList.contains('remove-season-btn')) { e.target.closest('.season-card').remove(); }
        });

        contentUploadForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const selectedType = contentTypeSelect.value;
            const formData = new FormData(contentUploadForm);
            if (selectedType === 'series') {
                if(uploadStatusDiv) {
                    uploadStatusDiv.style.display = 'block';
                    uploadStatusDiv.querySelector('.upload-header').textContent = "Processing Series...";
                    if(progressCircle) progressCircle.style.display = 'none';
                }
                if(uploadBtn) uploadBtn.disabled = true;
                seriesAbortController = new AbortController();
                
                const actorsJson = formData.get('actors_json') || '[]';
                let actorsList = [];
                try {
                    actorsList = JSON.parse(actorsJson);
                } catch(e) { console.error("Could not parse actors JSON", e); }
                
                const seriesData = {
                    title: formData.get('title'), description: formData.get('description'), genres: formData.get('genres'),
                    release_date: formData.get('release_date'), director: formData.get('director'),
                    tmdb_id: formData.get('tmdb_id'), poster_url: formData.get('poster_url'), 
                    content_type: 'series', seasons: [], actors: actorsList
                };
                document.querySelectorAll('.season-card').forEach((seasonCard, seasonIndex) => {
                    const seasonObject = { title: `Season ${seasonIndex + 1}`, episodes: [] };
                    seasonCard.querySelectorAll('.episode-item').forEach(episodeItem => {
                        const episodeEmbed = episodeItem.querySelector('.episode-embed').value;
                        if(episodeEmbed) {
                            seasonObject.episodes.push({
                                number: episodeItem.querySelector('.episode-number').value,
                                title: episodeItem.querySelector('.episode-title').value,
                                embed_code: episodeEmbed
                            });
                        }
                    });
                    if (seasonObject.episodes.length > 0) { seriesData.seasons.push(seasonObject); }
                });
                fetch("{{ url_for('admin_dashboard') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': formData.get('csrf_token') },
                    body: JSON.stringify(seriesData),
                    signal: seriesAbortController.signal
                }).then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.message || 'Server error'); }); }
                    return response.json();
                }).then(data => {
                    if (data.success) {
                        if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Series Added Successfully!";
                        alert('Series added successfully!');
                        setTimeout(() => { location.reload(); }, 1500);
                    } else { throw new Error(data.message || 'An unknown error occurred.'); }
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Submission Cancelled";
                        setTimeout(() => { if(uploadStatusDiv) uploadStatusDiv.style.display = 'none'; }, 1500);
                    } else {
                        if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Failed to add series: " + error.message;
                        alert('Error: ' + error.message);
                    }
                    if(uploadBtn) uploadBtn.disabled = false;
                });
            } else {
                if (!movieEmbedCodeInput || !movieEmbedCodeInput.value.trim()) { alert('Movie Embed Code / URL is required!'); return; }
                if(uploadStatusDiv) {
                    uploadStatusDiv.style.display = 'block';
                    uploadStatusDiv.querySelector('.upload-header').textContent = "Uploading Movie...";
                    if(progressCircle) progressCircle.style.display = 'block';
                }
                if(uploadBtn) uploadBtn.disabled = true;
                if(progressCirclePath) progressCirclePath.setAttribute('stroke-dasharray', '0, 100');
                if(uploadPercentText) uploadPercentText.textContent = '0%';
                uploadXhr = new XMLHttpRequest();
                uploadXhr.open('POST', contentUploadForm.action, true);
                uploadXhr.upload.onprogress = function (event) {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        if(progressCirclePath) progressCirclePath.setAttribute('stroke-dasharray', `${percentComplete}, 100`);
                        if(uploadPercentText) uploadPercentText.textContent = `${percentComplete}%`;
                    }
                };
                uploadXhr.onload = function () {
                    if (uploadXhr.status >= 200 && uploadXhr.status < 400) {
                        if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Movie Added Successfully!";
                        setTimeout(() => { location.reload(); }, 1000);
                    } else {
                        if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Upload Failed!";
                        alert('An error occurred during upload.');
                    }
                    if(uploadBtn) uploadBtn.disabled = false;
                };
                uploadXhr.onerror = function () {
                    if(uploadStatusDiv) uploadStatusDiv.querySelector('.upload-header').textContent = "Network Error!";
                    alert('A network error occurred.');
                    if(uploadBtn) uploadBtn.disabled = false;
                };
                uploadXhr.onabort = function () {
                    if(uploadStatusDiv) uploadStatusDiv.style.display = 'none';
                    if(uploadBtn) uploadBtn.disabled = false;
                };
                uploadXhr.send(formData);
            }
        });

        cancelUploadBtn.addEventListener('click', function () {
            if (seriesAbortController) { seriesAbortController.abort(); }
            if (uploadXhr) { uploadXhr.abort(); }
        });

        const actorsJsonInput = document.getElementById('actors_json');
        fetchTmdbDataBtn.addEventListener('click', async function() {
            // ... (rest of TMDB fetch logic)
            // Ensure the response handling includes this:
            // const actorsData = data.actors || [];
            // actorsInput.value = actorsData.map(a => a.name).join(', ');
            // actorsJsonInput.value = JSON.stringify(actorsData);
        });
    });
    </script>
</body>
</html>
```

---

### 2. `movie_detail.html` (Complete & Corrected)

This file is now updated to properly display cast photos and contains all the other necessary fixes for the universal player and conditional sections.


```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ item.title }} - 4KHDHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Exo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon/favicon-movie.png') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        :root {
            --bg-dark-1: #101010;
            --bg-dark-1-rgb: 16,16,16;
            --bg-dark-2: #181818;
            --bg-dark-2-rgb: 24, 24, 24;
            --bg-dark-3: #222222;
            --text-light: #E0E0E0;
            --text-muted: #858585;
            --text-footer-headings: #b0b0b0;
            --accent-primary: #FF8C00;
            --accent-primary-rgb: 255, 140, 0;
            --accent-secondary: #E57E00;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --card-shadow-light: rgba(0, 0, 0, 0.3);
            --card-shadow-hover: rgba(var(--accent-primary-rgb), 0.2);
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Exo 2', sans-serif;
        }
        body { margin: 0; font-family: var(--font-main); background-color: var(--bg-dark-1); color: var(--text-light); line-height: 1.7; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; background-image: radial-gradient(ellipse at 50% 0%, rgba(var(--bg-dark-2-rgb), 0.35) 0%, var(--bg-dark-1) 75%); background-attachment: fixed; }
        .main-content-area { flex-grow: 1; }
        .container { max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 20px; }
        .breadcrumb-bar { background-color: var(--bg-dark-2); padding: 10px 0; font-size: 0.9rem; border-bottom: 1px solid var(--border-subtle); }
        .breadcrumb-bar .container a { color: var(--text-muted); text-decoration: none; }
        .breadcrumb-bar .container a:hover { color: var(--accent-primary); }
        .breadcrumb-bar .container span { color: var(--text-muted); margin: 0 5px; }
        .breadcrumb-bar .container .current-page { color: var(--text-light); }
        .movie-hero-section { position: relative; padding: clamp(30px, 8vh, 60px) 0; background-size: cover; background-position: center top; background-repeat: no-repeat; min-height: 55vh; display: flex; align-items: center; }
        .movie-hero-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, var(--bg-dark-1) 5%, rgba(var(--bg-dark-1-rgb),0.7) 40%, rgba(var(--bg-dark-1-rgb),0.4) 70%, rgba(var(--bg-dark-1-rgb),0.8) 100%); z-index: 1; }
        .movie-hero-section .container { position: relative; z-index: 2; }
        .hero-content { display: flex; gap: clamp(20px, 4vw, 40px); align-items: flex-start; }
        .hero-poster img { content: url('{{ item.display_poster }}'); width: clamp(200px, 25vw, 280px); height: auto; aspect-ratio: 2/3; object-fit: cover; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid var(--border-subtle); }
        .hero-details { flex: 1; padding-top: clamp(0px, 2vh, 20px); }
        .hero-title { font-family: var(--font-heading); font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 800; color: #fff; margin-bottom: 10px; line-height: 1.1; text-shadow: 0 2px 10px rgba(0,0,0,0.7); }
        .hero-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 8px 15px; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); }
        .hero-meta span { display: inline-flex; align-items: center; }
        .hero-meta .rating { color: var(--accent-primary); font-weight: 700; }
        .hero-meta .rating i { margin-right: 5px; }
        .hero-meta .genre-tag { background-color: rgba(var(--accent-primary-rgb), 0.15); color: var(--accent-primary); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 500; border: 1px solid rgba(var(--accent-primary-rgb), 0.3); }
        .hero-description { font-size: clamp(0.9rem, 1.8vw, 1rem); line-height: 1.6; color: var(--text-light); margin-bottom: 25px; max-width: 700px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .hero-actions .btn { font-family: var(--font-heading); font-weight: 600; padding: 10px 25px; border-radius: 25px; text-decoration: none; margin-right: 10px; margin-bottom:10px; transition: all 0.3s ease; font-size: clamp(0.9rem, 1.8vw, 1rem); display: inline-flex; align-items: center; gap: 8px; }
        .hero-actions .btn-primary { background-color: var(--accent-primary); color: var(--bg-dark-1); border: 2px solid var(--accent-primary); }
        .hero-actions .btn-primary:hover { background-color: var(--accent-secondary); border-color: var(--accent-secondary); transform: translateY(-3px); box-shadow: 0 4px 15px rgba(var(--accent-primary-rgb), 0.3); }
        .page-section { padding: clamp(1.5rem, 4vw, 2.5rem) 0; background-color: var(--bg-dark-2); margin-bottom: 1px; }
        .page-section:nth-child(even) { background-color: var(--bg-dark-1); }
        .section-heading { font-family: var(--font-heading); font-size: clamp(1.5rem, 3vw, 2rem); font-weight: 700; color: var(--text-light); margin-bottom: clamp(1rem, 2.5vw, 1.5rem); display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--accent-primary); padding-bottom: 10px; }
        .player-section .player-container { background-color: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 100%; margin: 0 auto; aspect-ratio: 16 / 9; max-height: 75vh; position: relative; }
        .player-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .series-selector { margin-top: clamp(1.5rem, 4vw, 2.5rem); }
        .accordion-item { background-color: var(--bg-dark-3); border: 1px solid var(--border-subtle); margin-bottom: 5px; border-radius: 8px !important; }
        .accordion-header .accordion-button { background-color: var(--bg-dark-3); color: var(--text-light); font-family: var(--font-heading); font-weight: 600; font-size: 1.2rem; border-radius: 8px !important; box-shadow: none; }
        .accordion-button:not(.collapsed) { background-color: var(--bg-dark-2) !important; color: var(--accent-primary) !important; box-shadow: inset 0 -1px 0 var(--border-subtle) !important; }
        .accordion-button::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23e0e0e0'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); }
        .accordion-button:not(.collapsed)::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ff8c00'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); }
        .accordion-body { background-color: var(--bg-dark-1); padding: 0; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .episode-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .episode-list .episode-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background-color 0.2s ease; }
        .episode-list .episode-item:last-child { border-bottom: none; }
        .episode-list .episode-item:hover { background-color: var(--bg-dark-3); }
        .episode-list .episode-item.active { background-color: rgba(var(--accent-primary-rgb), 0.15); border-left: 4px solid var(--accent-primary); padding-left: 16px; }
        .episode-list .episode-item .ep-num { color: var(--text-muted); font-weight: 600; margin-right: 15px; min-width: 25px; }
        .episode-list .episode-item .ep-title { color: var(--text-light); flex-grow: 1; }
        .episode-list .episode-item.active .ep-title { color: var(--accent-primary); font-weight: 600; }
        .episode-list .episode-item .ep-play-icon { color: var(--accent-primary); font-size: 1.5rem; opacity: 0; transition: opacity 0.2s ease; }
        .episode-list .episode-item:hover .ep-play-icon, .episode-list .episode-item.active .ep-play-icon { opacity: 1; }
        .overview-section .full-synopsis { font-size: 1.05rem; line-height: 1.8; margin-bottom: clamp(1.5rem, 4vw, 2.5rem); color: var(--text-light); }
        .overview-section .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: clamp(1rem, 2.5vw, 1.5rem); margin-bottom: clamp(1.5rem, 4vw, 2.5rem); }
        .overview-section .detail-item strong { color: var(--text-muted); font-weight: 600; margin-right: 8px; display: block; margin-bottom: 4px; }
        .overview-section .detail-item span { color: var(--text-light); }
        .cast-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: clamp(1rem, 2.5vw, 1.5rem); }
        .cast-member { text-align: center; }
        .cast-member img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; background-color: var(--bg-dark-3); }
        .cast-member .name { font-size: 0.9rem; font-weight: 500; color: var(--text-light); }
        .related-movies-grid { display: grid; gap: clamp(1rem, 2.5vw, 1.5rem); grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .related-movies-grid .movie-card-link { text-decoration: none; display: flex; flex-direction: column; height: 100%; border-radius: 10px; transition: all 0.35s ease; background-color: var(--bg-dark-3); }
        .related-movies-grid .movie-card-link:hover { transform: translateY(-8px) scale(1.04); box-shadow: 0 12px 28px var(--card-shadow-light), 0 0 20px var(--card-shadow-hover); background-color: var(--bg-dark-2); }
        .related-movies-grid .movie-poster { width: 100%; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 8px 8px 0 0; background-color: var(--bg-dark-1); }
        .related-movies-grid .movie-info { padding: clamp(0.5rem, 1.5vw, 1rem); }
        .related-movies-grid .movie-title { font-family: var(--font-heading); font-size: clamp(0.8rem, 1.8vw, 0.9rem); font-weight: 600; color: var(--text-light); line-height: 1.35; height: calc(0.9rem * 1.35 * 2); max-height: calc(0.9rem * 1.35 * 2); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 0.2rem; }
        .related-movies-grid .movie-meta { font-size: clamp(0.7rem, 1.5vw, 0.75rem); color: var(--text-muted); line-height: 1.2; height: calc(0.75rem * 1.2 * 1); max-height: calc(0.75rem * 1.2 * 1); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .related-movies-grid .movie-card-link:hover .movie-title { color: var(--accent-primary); }
        .site-footer { background-color: #000000; color: var(--text-muted); padding: clamp(1.5rem, 4vw, 2.5rem) 0 clamp(1rem, 2.5vw, 1.5rem) 0; margin-top: auto; border-top: 1px solid var(--border-subtle); font-size: 0.9rem; }
        .site-footer .footer-brand { font-family: var(--font-heading); font-size: 1.8rem; color: var(--text-light); margin-bottom: 0.5rem; display: block; text-decoration: none; }
        .site-footer .footer-brand .logo-hd { color: var(--accent-primary); font-weight: 900; }
        .site-footer .footer-tagline { font-size: 0.85rem; margin-bottom: 1.5rem; max-width: 300px; }
        .site-footer .footer-heading { font-family: var(--font-heading); font-size: 1.1rem; font-weight: 600; color: var(--text-footer-headings); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .site-footer .footer-links { list-style: none; padding-left: 0; margin-bottom: 0; }
        .site-footer .footer-links li { margin-bottom: 0.6rem; }
        .site-footer .footer-links a { color: var(--text-muted); text-decoration: none; transition: color 0.2s ease, padding-left 0.2s ease; display: inline-block; }
        .site-footer .footer-links a:hover { color: var(--accent-primary); padding-left: 5px; }
        .site-footer .footer-bottom { border-top: 1px solid var(--border-subtle); margin-top: clamp(1.5rem, 4vw, 2.5rem); padding-top: clamp(1rem, 2.5vw, 1.5rem); text-align: center; font-size: 0.8rem; }
        .site-footer .footer-bottom p { margin-bottom: 0.25rem; }
        .site-footer .footer-bottom a { color: red; }
        .site-footer .footer-bottom a:hover { color: var(--accent-primary); text-decoration: underline; }
        @media (max-width: 992px) { .hero-content { flex-direction: column; align-items: center; text-align: center; } .hero-poster img { width: clamp(180px, 30vw, 220px); margin-bottom: 20px; } .hero-details { padding-top: 0; align-items: center; } .hero-description { max-width: 100%; -webkit-line-clamp: 4; } .hero-actions { text-align: center; } .related-movies-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } }
        @media (max-width: 768px) { .hero-actions .btn { width: auto; padding: 10px 20px; font-size: 0.9rem; } .overview-section .details-grid { grid-template-columns: 1fr; } .related-movies-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } .site-footer .footer-brand, .site-footer .footer-tagline { text-align: center; margin-left: auto; margin-right: auto; } .site-footer .footer-heading { margin-top: 1.5rem; } .site-footer .footer-links { text-align: center; } }
        @media (max-width: 576px) { .hero-poster img { width: clamp(150px, 45vw, 180px); } .hero-title { font-size: clamp(1.8rem, 7vw, 2.5rem); } .hero-meta { font-size: 0.85rem; justify-content: center; } .hero-meta .genre-tag { font-size: 0.75rem; padding: 3px 8px;} .hero-actions .btn { width: 100%; margin-right: 0; } .section-heading { font-size: clamp(1.3rem, 2.5vw, 1.7rem); } .player-section .player-container { max-height: 45vh; } .related-movies-grid { grid-template-columns: repeat(2, 1fr); gap: clamp(0.5rem, 1.5vw, 1rem); } .related-movies-grid .movie-title { height: calc(0.8rem * 1.35 * 2); max-height: calc(0.8rem * 1.35 * 2); font-size: clamp(0.75rem, 2.5vw, 0.8rem); } .related-movies-grid .movie-meta { height: calc(0.7rem * 1.2 * 1); max-height: calc(0.7rem * 1.2 * 1); font-size: clamp(0.65rem, 2vw, 0.7rem); } }
    </style>
</head>
<body>
    <div class="main-content-area">
        <div class="breadcrumb-bar">
            <div class="container">
                <a href="{{ url_for('index') }}">Home</a>
                <span>/</span>
                <a href="{{ url_for('index', category='all-movies' if item.content_type == 'movie' else 'all-series') }}">{{ 'Movies' if item.content_type == 'movie' else 'Series' }}</a> 
                <span>/</span>
                <span class="current-page">{{ item.title }}</span>
            </div>
        </div>

        <section class="movie-hero-section" style="background-image: url('{{ item.display_poster }}');">
            <div class="container">
                <div class="hero-content">
                    <div class="hero-poster">
                        <img src="{{ item.display_poster }}" alt="{{ item.title }} Poster" onerror="this.onerror=null; this.src='https://via.placeholder.com/280x420/181818/858585.png?text=No+Poster';"/>
                    </div>
                    <div class="hero-details">
                        <h1 class="hero-title">{{ item.title }}</h1>
                        <div class="hero-meta">
                            {% if item.release_date %}<span><i class="bi bi-calendar3"></i> {{ item.release_date[:4] }}</span>{% endif %}
                        </div>
                        <div class="hero-meta genres">
                             {% if item.genre_list %}
                                 {% for g in item.genre_list %}
                                     <span class="genre-tag">{{ g }}</span>
                                 {% endfor %}
                             {% else %}
                                 <span class="genre-tag">N/A</span>
                             {% endif %}
                        </div>
                        <p class="hero-description">{{ item.description | default('', true) | striptags | truncate(250) }}</p>
                        <div class="hero-actions">
                            <a href="#movie-player-section" class="btn btn-primary">
                                <i class="bi bi-play-circle-fill"></i> {{ 'Play Series' if item.content_type == 'series' else 'Play Movie' }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="page-section player-section" id="movie-player-section">
            <div class="container">
                <h2 class="section-heading"><i class="bi bi-film"></i> Watch Now</h2>
                <div class="player-container">
                    {% if item.content_type == 'movie' %}
                        {% if item.embed_code %}{{ item.embed_code | safe }}{% else %}<p>Video not available.</p>{% endif %}
                    {% elif item.content_type == 'series' %}
                        {% if item.seasons and item.seasons[0].episodes %}{{ item.seasons[0].episodes[0].embed_code | safe }}{% else %}<p>No episodes available.</p>{% endif %}
                    {% endif %}
                </div>
                
                {% if item.content_type == 'series' and item.seasons %}
                <div class="series-selector">
                    <div class="accordion" id="seasonsAccordion">
                        {% for season in item.seasons %}
                        {% set is_first_season = loop.first %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-season-{{ loop.index }}">
                                <button class="accordion-button {% if not is_first_season %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-season-{{ loop.index }}" aria-expanded="{{ 'true' if is_first_season else 'false' }}" aria-controls="collapse-season-{{ loop.index }}">
                                    Season {{ loop.index }}
                                </button>
                            </h2>
                            <div id="collapse-season-{{ loop.index }}" class="accordion-collapse collapse {% if is_first_season %}show{% endif %}" aria-labelledby="heading-season-{{ loop.index }}">
                                <div class="accordion-body">
                                    <ul class="episode-list">
                                        {% for episode in season.episodes %}
                                        <li class="episode-item episode-play-btn {% if is_first_season and loop.first %}active{% endif %}" data-template-id="ep-{{ season.id }}-{{ episode.id }}">
                                            <span class="ep-num">{{ episode.number }}</span>
                                            <span class="ep-title">{{ episode.title | default('Episode ' ~ episode.number) }}</span>
                                            <i class="bi bi-play-circle-fill ep-play-icon"></i>
                                            <template id="ep-{{ season.id }}-{{ episode.id }}">{{ episode.embed_code | safe }}</template>
                                        </li>
                                        {% else %}
                                        <li class="episode-item" style="justify-content: center; color: var(--text-muted);">No episodes yet.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <section class="page-section overview-section">
            <div class="container">
                <h2 class="section-heading"><i class="bi bi-info-lg"></i> Overview & Details</h2>
                <div class="full-synopsis">
                    <p>{{ item.description | default("No description available.", true) | striptags }}</p>
                </div>
                <div class="details-grid">
                    <div class="detail-item"><strong>Title:</strong> <span>{{ item.title }}</span></div>
                    <div class="detail-item"><strong>Release Date:</strong> <span>{{ item.release_date | default('N/A') }}</span></div>
                    <div class="detail-item"><strong>Genres:</strong> <span>{{ item.genre if item.genre else 'N/A' }}</span></div>
                    <div class="detail-item">
                        <strong>{{ 'Creator' if item.content_type == 'series' else 'Director' }}:</strong>
                        <span>{{ item.director | default('N/A') }}</span>
                    </div>
                </div>
                <h3 class="section-heading" style="font-size: 1.5rem; margin-top: clamp(1.5rem, 4vw, 2.5rem); border-top: 1px solid var(--border-subtle); padding-top: clamp(1rem, 2.5vw, 1.5rem);"><i class="bi bi-people-fill"></i> Cast</h3>
                <div class="cast-grid">
                    {% if cast %}
                        {% for actor in cast %}
                        <div class="cast-member">
                            {% if actor.profile_path %}
                                <img src="https://image.tmdb.org/t/p/w185{{ actor.profile_path }}" alt="{{ actor.name }}">
                            {% else %}
                                <img src="https://via.placeholder.com/80x80/333333/858585.png?text={{ actor.name[0] | upper if actor.name else '?' }}" alt="{{ actor.name }}">
                            {% endif %}
                            <div class="name">{{ actor.name }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <p>No cast information available.</p>
                    {% endif %}
                </div>
            </div>
        </section>

        {% if related_movies and related_movies|length > 0 %}
        <section class="page-section related-movies-section">
            <div class="container">
                <h2 class="section-heading"><i class="bi bi-collection-play-fill"></i> You Might Also Like</h2>
                <div class="related-movies-grid">
                    {% for related in related_movies %}
                    <a href="{{ url_for('series_detail', series_id=related.id) if related.content_type == 'series' else url_for('movie_detail', movie_id=related.id) }}" class="movie-card-link">
                        <div class="movie-card-content">
                            <img src="{{ related.thumbnail_display }}" alt="{{ related.title }} Poster" class="movie-poster" onerror="this.onerror=null; this.src='https://via.placeholder.com/140x210/181818/858585.png?text=N/A';"/>
                            <div class="movie-info">
                                <p class="movie-title">{{ related.title }}</p>
                                {% if related.release_date %}<p class="movie-meta">{{ related.release_date[:4] }}</p>{% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
                    <a class="footer-brand" href="{{ url_for('index') }}">
                        <span class="logo-hd">Flix</span>HD
                    </a>
                    <p class="footer-tagline">Your ultimate destination for a cinematic universe, streamed directly to you.</p>
                </div>
                <div class="col-lg-2 col-md-3 col-6 mb-4 mb-lg-0">
                    <h5 class="footer-heading">Explore</h5>
                    <ul class="footer-links">
                        <li><a href="{{ url_for('index') }}">Home</a></li>
                        <li><a href="{{ url_for('index', category='all-movies') }}">Movies</a></li>
                        <li><a href="{{ url_for('index', category='all-series') }}">Web Series</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-3 col-6 mb-4 mb-lg-0">
                    <h5 class="footer-heading">Support</h5>
                    <ul class="footer-links">
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 mb-4 mb-lg-0">
                     <h5 class="footer-heading">Connect</h5>
                     <p>Follow us on social media.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; Aayush Lamsal. All Rights Reserved.</p>
                <p> |<a href="/admin/login"> Admin Login </a> |</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const playerContainer = document.querySelector('.player-container');
            const episodeButtons = document.querySelectorAll('.episode-play-btn');

            episodeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const templateId = this.dataset.templateId;
                    const template = document.getElementById(templateId);

                    if (playerContainer && template) {
                        playerContainer.innerHTML = template.innerHTML;
                        episodeButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        playerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        });
    </script>
</body>
</html>
